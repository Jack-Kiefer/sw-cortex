<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SERP Migration Plan - Part 1: Foundation ‚Äî 17 Weeks (Custom Branding, POs)</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f8f9fa;
        color: #333;
        line-height: 1.6;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 0;
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 30px;
      }
      h1 {
        color: #212529;
        font-size: 1.8em;
      }
      .meta {
        color: #6c757d;
        font-size: 0.9em;
      }
      .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
      }
      .summary-card {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
      }
      .summary-card .value {
        font-size: 2em;
        font-weight: 700;
        color: #198754;
      }
      .summary-card .label {
        color: #6c757d;
        font-size: 0.85em;
        margin-top: 5px;
      }
      .timeline-container {
        background: #fff;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
      }
      .timeline-header {
        display: flex;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 10px;
        margin-bottom: 15px;
      }
      .timeline-label {
        width: 220px;
        font-weight: 600;
        color: #495057;
        font-size: 0.9em;
      }
      .timeline-months {
        display: flex;
        flex: 1;
      }
      .month-col {
        flex: 1;
        text-align: center;
        font-size: 0.8em;
        font-weight: 600;
        color: #495057;
        padding: 8px 4px;
        border-left: 1px solid #e9ecef;
        background: #f8f9fa;
      }
      .month-col:first-child {
        border-left: none;
      }
      .phase-row {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }
      .phase-label {
        width: 220px;
        font-weight: 500;
        font-size: 0.9em;
        color: #495057;
      }
      .phase-track {
        flex: 1;
        height: 44px;
        position: relative;
        display: flex;
        align-items: center;
        background: #f8f9fa;
        border-radius: 6px;
      }
      .phase-bar {
        position: absolute;
        height: 36px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 12px;
        font-size: 0.8em;
        font-weight: 500;
        color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
      }
      .phase-dates {
        font-size: 0.75em;
        opacity: 0.9;
      }
      .phase-detail {
        background: #fff;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        overflow: hidden;
      }
      .phase-header {
        padding: 24px;
        border-left: 5px solid;
        cursor: pointer;
        transition: background 0.2s;
      }
      .phase-header:hover {
        background: #f8f9fa;
      }
      .phase-header h2 {
        font-size: 1.3em;
        margin-bottom: 8px;
        color: #212529;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .phase-header h2 .toggle {
        font-size: 0.8em;
        color: #6c757d;
        transition: transform 0.2s;
        transform: rotate(90deg);
      }
      .phase-header.collapsed h2 .toggle {
        transform: rotate(0deg);
      }
      .phase-meta-info {
        color: #6c757d;
        font-size: 0.9em;
        margin-bottom: 12px;
      }
      .phase-goal-text {
        background: #f8f9fa;
        padding: 14px;
        border-radius: 8px;
        color: #495057;
        font-size: 0.95em;
      }
      .phase-content {
        display: block;
        padding: 0 24px 24px;
        border-top: 1px solid #e9ecef;
      }
      .phase-content.hide {
        display: none;
      }
      .section {
        margin-top: 24px;
      }
      .section h3 {
        font-size: 1.05em;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 2px solid;
        color: #495057;
      }
      .section h4 {
        font-size: 0.95em;
        margin: 16px 0 8px;
        color: #495057;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 12px 0;
        font-size: 0.9em;
      }
      th,
      td {
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
      }
      th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
      }
      .owner-cell {
        color: #198754;
        font-weight: 600;
      }
      .copy-cell {
        color: #6c757d;
      }
      .migration-header-row {
        background: #f8f9fa !important;
        border-top: 2px solid #dee2e6;
        border-bottom: 2px solid #dee2e6;
      }
      .migration-header-row td {
        font-weight: 600;
        color: #495057;
        padding: 12px;
      }
      .migration-header-row .table-name {
        color: #0d6efd;
        font-size: 0.95em;
      }
      .table-row {
        background: white;
      }
      .table-row .table-name {
        font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
        font-size: 0.9em;
        color: #198754;
        font-weight: 500;
        padding-left: 24px;
      }
      .table-row .purpose {
        color: #495057;
      }
      .table-row .columns {
        font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
        font-size: 0.85em;
        color: #6c757d;
      }
      .workflow-table th:first-child {
        background: #e8f5e9;
        color: #198754;
      }
      .workflow-table th:last-child {
        background: #f3e5f5;
        color: #7b1fa2;
      }
      .workflow-table .sync-row {
        background: #fff3cd;
      }
      .workflow-table .arrow {
        text-align: center;
        color: #6c757d;
      }
      ul {
        margin: 8px 0;
        padding-left: 24px;
      }
      li {
        margin: 6px 0;
      }
      .highlight {
        background: #fff3cd;
        padding: 12px 16px;
        border-left: 4px solid;
        margin: 16px 0;
        font-weight: 500;
      }
      code {
        background: #f1f3f5;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.85em;
      }
      .gantt-container {
        overflow-x: auto;
        margin-top: 16px;
      }
      .gantt-header {
        display: flex;
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 8px;
        min-width: 800px;
      }
      .gantt-label {
        width: 280px;
        min-width: 280px;
        padding: 10px;
        font-weight: 600;
        color: #495057;
        font-size: 0.85em;
      }
      .gantt-weeks {
        display: flex;
        flex: 1;
      }
      .week-col {
        flex: 1;
        text-align: center;
        padding: 8px 4px;
        font-size: 0.75em;
        font-weight: 600;
        color: #495057;
        border-left: 1px solid #e9ecef;
        background: #f8f9fa;
      }
      .week-col:first-child {
        border-left: none;
      }
      .week-dates {
        font-size: 0.7em;
        color: #6c757d;
        font-weight: 400;
      }
      .gantt-row {
        display: flex;
        align-items: center;
        min-height: 36px;
        border-bottom: 1px solid #f1f3f5;
        min-width: 800px;
      }
      .gantt-row:hover {
        background: #f8f9fa;
      }
      .task-label {
        width: 280px;
        min-width: 280px;
        padding: 6px 10px;
        font-size: 0.85em;
        color: #495057;
      }
      .task-track {
        display: flex;
        flex: 1;
        position: relative;
        height: 26px;
      }
      .task-cell {
        flex: 1;
        border-left: 1px solid #f1f3f5;
      }
      .task-cell:first-child {
        border-left: none;
      }
      .task-bar {
        position: absolute;
        height: 20px;
        top: 3px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7em;
        font-weight: 500;
        color: white;
      }
      .milestones {
        background: #fff;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 30px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
      }
      .milestones h3 {
        margin-bottom: 20px;
        color: #495057;
        font-size: 1.1em;
      }
      .milestone-item {
        display: flex;
        align-items: center;
        padding: 14px 0;
        border-bottom: 1px solid #e9ecef;
      }
      .milestone-item:last-child {
        border-bottom: none;
      }
      .milestone-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 15px;
      }
      .milestone-info {
        flex: 1;
      }
      .milestone-name {
        font-weight: 500;
        color: #212529;
      }
      .milestone-phase {
        font-size: 0.85em;
        color: #6c757d;
      }
      .milestone-date {
        font-weight: 600;
        color: #198754;
      }
      .migration-events {
        background: #fff;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
      }
      .migration-events h3 {
        margin-bottom: 5px;
        color: #495057;
      }
      .migration-event {
        display: flex;
        align-items: flex-start;
        padding: 12px 0;
        border-bottom: 1px solid #f1f3f5;
      }
      .migration-event:last-child {
        border-bottom: none;
      }
      .migration-event-phase {
        width: 100px;
        min-width: 100px;
        font-weight: 600;
        font-size: 0.85em;
      }
      .migration-event-week {
        width: 80px;
        min-width: 80px;
        color: #6c757d;
        font-size: 0.85em;
      }
      .migration-event-info {
        flex: 1;
      }
      .migration-event-name {
        font-weight: 600;
        margin-bottom: 4px;
      }
      .migration-event-desc {
        color: #6c757d;
        font-size: 0.85em;
      }
      .migration-event-tables {
        margin-top: 6px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .migration-event-tables code {
        background: #e9ecef;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.75em;
      }
      @media print {
        .phase-content {
          display: block !important;
        }
        .phase-header {
          break-after: avoid;
        }
        .phase-detail {
          break-inside: avoid;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div>
          <h1>SERP Migration Plan - Part 1: Foundation ‚Äî 17 Weeks (Custom Branding, POs)</h1>
          <div class="meta" id="meta"></div>
        </div>
      </header>
      <div class="summary-cards" id="summary"></div>
      <div class="timeline-container">
        <div class="timeline-header">
          <div class="timeline-label">Phase</div>
          <div class="timeline-months" id="months"></div>
        </div>
        <div id="timeline"></div>
        <div style="margin-top: 12px; font-size: 0.8em; color: #6c757d">
          <strong>‚à•</strong> = Phases run in parallel
        </div>
      </div>
      <div class="migration-events">
        <h3>üì¶ Data Migration Timeline</h3>
        <p style="color: #6c757d; font-size: 0.9em; margin-bottom: 15px">
          When Odoo data gets imported into SERP tables
        </p>
        <div id="migration-events"></div>
      </div>
      <div class="milestones">
        <h3>Key Milestones</h3>
        <div id="milestones"></div>
      </div>
      <h2 style="margin: 30px 0 20px; color: #495057; font-size: 1.3em">Phase Details</h2>
      <div id="phases-detail"></div>
    </div>
    <script>
      const PROJECT_START = '2026-02-16';
      const project = { startDate: PROJECT_START, preparedBy: 'Jack Kiefer' };

      const phases = [
        {
          id: 1,
          name: 'Custom Branding Infrastructure',
          shortName: 'Branding',
          weeks: 9,
          deps: [],
          color: '#e67e22',
          milestone: 'Custom Branding Inventory Live',
          goal: 'Build SERP backend infrastructure (migrations 001-010). Create database schema, build core services for PO management, inventory tracking, FIFO costing. Test with custom branding products (backend only, no UI). Foundation for all future phases.',
          goals: [
            'Create migrations 001-010: purchase_orders, lines, suppliers, bills, stock_quant, stock_move, valuation layers',
            'Build core PO services: create, receive, bill creation (reusable code for Phase 3)',
            'Build inventory services: adjust, reserve, deduct, FIFO consumption (reusable code)',
            'Build order APIs for Laravel integration: /api/orders/reserve, /ship, /cancel',
            'Build component inventory view: aggregate stock_quant (reserved + on-hand)',
            'Test complete custom branding workflow end-to-end (backend APIs only)',
            'NO UI in this phase - backend infrastructure only',
            'NO Odoo sync in this phase - that comes in Phase 3',
          ],
          tasks: [
            {
              name: 'Create migrations 001-010: database schema (POs, inventory, bills, views)',
              startWeek: 1,
              duration: 3,
            },
            {
              name: 'Send finalized migrations to Laravel team',
              startWeek: 3,
              duration: 1,
            },
            {
              name: 'Build PO services (create, send, receive, bill)',
              startWeek: 4,
              duration: 2,
            },
            {
              name: 'Build inventory services (adjust, reserve, deduct, FIFO)',
              startWeek: 4,
              duration: 2,
            },
            {
              name: 'Build order APIs: /api/orders/reserve, /ship, /cancel',
              startWeek: 6,
              duration: 1,
            },
            {
              name: 'Backend API testing: PO + inventory + order workflow',
              startWeek: 7,
              duration: 2,
            },
          ],
          workflow: [
            { laravel: '--- CUSTOM BRANDING WORKFLOW (Phase 1 only) ---', odoo: '---' },
            { laravel: 'Create custom branding component in components table', odoo: '‚Äî' },
            { laravel: 'Create supplier record', odoo: '‚Äî' },
            { laravel: 'Create PO with lines for custom branding components', odoo: '‚Äî' },
            { laravel: 'Send PO to supplier (email/PDF)', odoo: '‚Äî' },
            { laravel: 'Receive PO arrival ‚Üí create stock_picking + stock_moves', odoo: '‚Äî' },
            { laravel: 'Update stock_quant (on-hand inventory)', odoo: '‚Äî' },
            { laravel: 'Create FIFO valuation layer (unit_cost from PO)', odoo: '‚Äî' },
            { laravel: '--- ORDER FULFILLMENT (via Laravel APIs) ---', odoo: '---' },
            { laravel: 'Laravel calls POST /api/orders/reserve ‚Üí reserve inventory', odoo: '‚Äî' },
            {
              laravel:
                'Laravel calls POST /api/orders/ship ‚Üí consume FIFO layers, return cost_unit',
              odoo: '‚Äî',
            },
            { laravel: 'Laravel calls POST /api/orders/cancel ‚Üí release reservations', odoo: '‚Äî' },
            { laravel: '--- BILLING ---', odoo: '---' },
            { laravel: 'Create vendor bill after invoice received', odoo: '‚Äî' },
          ],
          dataOwnership: [
            { data: 'Custom branding components', laravel: 'Owner', odoo: '‚Äî' },
            { data: 'Custom branding inventory (stock_quant)', laravel: 'Owner', odoo: '‚Äî' },
            { data: 'Custom branding inventory moves', laravel: 'Owner', odoo: '‚Äî' },
            { data: 'Custom branding COGS', laravel: 'Owner', odoo: '‚Äî' },
          ],
          dbChanges: [
            {
              table: 'üìã Migration 001: Foundation',
              purpose: 'Chatter system and entity tracking',
              columns: 'message_subtype, mail_message, entity_field_change, entity_attachment',
            },
            {
              table: 'message_subtype',
              purpose: 'Predefined message types (created, updated, RFQ sent, goods received)',
              columns: '‚Äî',
            },
            {
              table: 'mail_message',
              purpose: 'Activity log - tracks comments, notes, system events (Odoo chatter)',
              columns: '‚Üí serp_users, ‚Üí suppliers',
            },
            {
              table: 'entity_field_change',
              purpose: 'Audit trail - what changed, old vs new value',
              columns: '‚Üí mail_message',
            },
            {
              table: 'entity_attachment',
              purpose: 'File attachments (vendor invoices, shipping docs)',
              columns: '‚Äî',
            },
            {
              table: 'üìã Migration 002: MRP System',
              purpose: 'Manufacturing BOMs and production orders',
              columns: 'mrp_bom, mrp_bom_line, mrp_production, mrp_unbuild',
            },
            {
              table: 'mrp_bom',
              purpose: 'Bill of Materials - product recipes',
              columns: '‚Üí components (via odoo_product_id), ‚Üí uom_uom',
            },
            {
              table: 'mrp_bom_line',
              purpose: 'BOM components - ingredients in recipe',
              columns: '‚Üí mrp_bom, ‚Üí components',
            },
            {
              table: 'mrp_production',
              purpose: 'Manufacturing orders',
              columns: '‚Üí mrp_bom, ‚Üí components',
            },
            {
              table: 'mrp_unbuild',
              purpose: 'Disassembly orders - reverse manufacturing',
              columns: '‚Üí components, ‚Üí mrp_production',
            },
            {
              table: 'üìã Migration 003: Suppliers & Locations',
              purpose: 'Adds Odoo columns to existing suppliers/locations tables',
              columns:
                'odoo_partner_id ‚Üí suppliers, odoo_warehouse_id/odoo_location_id ‚Üí locations',
            },
            {
              table: 'üìã Migration 004: UOM Foundation',
              purpose: 'Units of measure',
              columns: 'uom_category, uom_uom',
            },
            {
              table: 'uom_category',
              purpose: 'UOM categories (Weight, Volume, Length, etc.)',
              columns: '‚Äî',
            },
            {
              table: 'uom_uom',
              purpose: 'Units of measure (kg, lb, L, gal, m, ft)',
              columns: '‚Üí uom_category',
            },
            {
              table: 'üìã Migration 005: Stock Locations',
              purpose: 'Warehouse structure and operation types',
              columns: 'stock_location, stock_picking_type',
            },
            {
              table: 'stock_location',
              purpose: 'Hierarchical warehouse locations (bins, zones, areas)',
              columns:
                'name, complete_name (path), parent_id, usage (internal/supplier/customer), scrap_location',
            },
            {
              table: 'stock_picking_type',
              purpose: 'Operation types - how receipts/deliveries/transfers behave',
              columns:
                'name, code (incoming/outgoing/internal/mrp), default_location_src_id, default_location_dest_id',
            },
            {
              table: 'üìã Migration 006: Inventory Operations',
              purpose: 'Inventory tracking and movements',
              columns:
                'stock_quant, stock_picking, stock_move, stock_move_line, product_supplierinfo',
            },
            {
              table: 'stock_quant',
              purpose: '‚≠ê INVENTORY TRUTH - current on-hand qty per product/location',
              columns: 'component_id, location_id, quantity, reserved_quantity, in_date, unit_cost',
            },
            {
              table: 'stock_picking',
              purpose:
                'Warehouse operations (receipts, deliveries, transfers) - groups stock_moves',
              columns:
                'name (WH/IN/00123), origin (PO#), location_id‚Üílocation_dest_id, state (draft‚Üíassigned‚Üídone), picking_type_id',
            },
            {
              table: 'stock_move',
              purpose: 'Individual inventory movements - move X units from A to B',
              columns:
                'product_uom_qty (requested), quantity_done (actual), state, picking_id, location_id‚Üílocation_dest_id, component_id',
            },
            {
              table: 'stock_move_line',
              purpose: 'Detailed lines within stock_move - for lot/serial tracking',
              columns: 'move_id, qty_done, location_id‚Üílocation_dest_id, lot_id, package_id',
            },
            {
              table: 'product_supplierinfo',
              purpose: 'Supplier-specific pricing/lead times per product',
              columns:
                'supplier_id, component_id, price, min_qty (MOQ), delay (lead time days), case_qty',
            },
            {
              table: 'üìã Migration 007: Inventory Valuation',
              purpose: 'FIFO costing and landed costs',
              columns:
                'stock_valuation_layer, stock_landed_cost, stock_landed_cost_lines, stock_landed_cost_stock_picking_rel',
            },
            {
              table: 'stock_valuation_layer',
              purpose:
                '‚≠ê FIFO COSTING - each receipt creates a layer; consumption decrements oldest first',
              columns:
                'component_id, quantity, unit_cost (from PO), remaining_qty (unconsumed), remaining_value (for GL), stock_move_id',
            },
            {
              table: 'stock_landed_cost',
              purpose: 'Landed cost adjustments (freight, customs, insurance)',
              columns: '‚Üí account_move',
            },
            {
              table: 'stock_landed_cost_lines',
              purpose: 'Cost distribution lines within landed cost',
              columns: '‚Üí stock_landed_cost, ‚Üí components',
            },
            {
              table: 'stock_landed_cost_stock_picking_rel',
              purpose: 'Junction - links landed costs to pickings',
              columns: '‚Üí stock_landed_cost, ‚Üí stock_picking',
            },
            {
              table: 'üìã Migration 008: Purchasing',
              purpose: 'Adds Odoo columns to existing purchase_orders/purchase_order_line tables',
              columns: 'odoo_id, date_order, date_planned, effective_date ‚Üí purchase_orders',
            },
            {
              table: 'üìã Migration 009: Accounting',
              purpose: 'Bills and journals (NO payment terms)',
              columns:
                'account_journal, account_move, account_move_line, account_move_purchase_order_rel',
            },
            {
              table: 'account_journal',
              purpose:
                'Journal types that categorize transactions (Vendor Bills, Inventory Valuation)',
              columns: '‚Äî',
            },
            {
              table: 'account_move',
              purpose: 'Vendor bills - MANUAL creation after vendor invoice received',
              columns: '‚Üí account_journal, ‚Üí suppliers, ‚Üí purchase_orders',
            },
            {
              table: 'account_move_line',
              purpose: 'Bill line items linked to PO lines for 3-way matching',
              columns: '‚Üí account_move, ‚Üí purchase_order_line, ‚Üí components, ‚Üí stock_move',
            },
            {
              table: 'account_move_purchase_order_rel',
              purpose: 'Junction - links bills to POs (one bill can reference multiple POs)',
              columns: '‚Üí account_move, ‚Üí purchase_orders',
            },
            {
              table: 'üìã Migration 010: Sales & Views',
              purpose: 'Sales integration and inventory views',
              columns:
                'serp_state, serp_picking_id ‚Üí ec_order; stock_move_id, cost_unit ‚Üí items/component_orders; component_inventory_summary VIEW',
            },
          ],
          implementation: [
            '--- CREATE MIGRATIONS 001-010 (Database Schema) ---',
            'Migration 001: Foundation - core tables',
            'Migration 002: MRP System - BOMs and manufacturing',
            'Migration 003: Suppliers and Locations',
            'Migration 004: UOM Foundation - units of measure',
            'Migration 005: Stock Locations - warehouse structure',
            'Migration 006: Inventory Operations - stock_picking, stock_move',
            'Migration 007: Inventory Valuation - FIFO costing layers',
            'Migration 008: Purchasing - POs and lines',
            'Migration 009: Accounting - journals, bills (NO payment terms)',
            'Migration 010: Sales and Views',
            '--- BUILD SERVICES (Reusable Code for Future Phases) ---',
            'PO services: create, send, receive, bill creation',
            'Inventory services: adjust, reserve, deduct, FIFO consumption',
            '--- BUILD ORDER APIs (For Laravel Integration) ---',
            'POST /api/orders/reserve - Reserve inventory for order, return picking_id + stock_move_id',
            'POST /api/orders/ship - Consume FIFO layers, return cost_unit per item',
            'POST /api/orders/cancel - Release reservations, cancel stock moves',
            '--- BACKEND API TESTING (No UI, No Order Processing) ---',
            'Create custom branding products in components table (via backend)',
            'Create POs for custom branding (backend API)',
            'Receive POs, validate FIFO costing (backend)',
            'Test inventory adjustments, reservations',
            'All testing via API calls, Postman, or scripts - NO UI',
            'Order workflow (ec_order ‚Üí component_orders) handled in Phase 2',
            'component_inventory VIEW created in Migration 010',
          ],
          confirmations: [
            'Tech team - backend APIs functional and tested',
            'Finance team - COGS calculation accuracy validated',
          ],
          keyPoint:
            'Phase 1 builds backend infrastructure ONLY (migrations 001-010, core services, order APIs). NO UI, NO Odoo sync. Custom branding products test the full PO ‚Üí inventory ‚Üí order fulfillment workflow. Phase 3 adds UI and Odoo sync.',
        },
        {
          id: 2,
          name: 'Laravel Order Queue (Custom Branding)',
          shortName: 'Laravel Queue',
          weeks: 9,
          deps: [],
          parallelWith: [1],
          color: '#f39c12',
          milestone: 'Custom Branding Orders Auto-Process',
          goal: 'Laravel developer integrates custom branding orders with SERP inventory system. Detect when orders are created/shipped/cancelled, communicate with SERP for inventory management, store results.',
          goals: [
            'Detect custom branding orders (merchandise_selections IS NOT NULL)',
            'Parse merchandise_selections and create component_orders records',
            'Stub SERP API calls in weeks 1-4 (mock responses), switch to real APIs in week 5 when Phase 1 APIs are ready',
            'Communicate with SERP for: reserve inventory, calculate COGS, release reservations',
            'Store SERP responses in Laravel: picking_id, stock_move_id, cost_unit',
            'Handle failures and retries',
          ],
          tasks: [
            {
              name: 'Design: Review SERP migrations, design integration approach',
              startWeek: 1,
              duration: 1,
            },
            {
              name: 'Implement: Laravel migrations + order detection logic',
              startWeek: 2,
              duration: 2,
            },
            {
              name: 'Implement: SERP integration + response handling',
              startWeek: 4,
              duration: 2,
            },
            {
              name: 'Testing: Integration testing with SERP + edge cases',
              startWeek: 6,
              duration: 1,
            },
          ],
          workflow: [
            { laravel: '1. Order created with merchandise_selections', odoo: '‚Äî' },
            { laravel: '2. Parse JSON ‚Üí create component_orders records', odoo: '‚Äî' },
            { laravel: '3. Trigger SERP reserve ‚Üí POST /api/orders/reserve', odoo: '‚Äî' },
            { laravel: '4. Store response: picking_id + stock_move_id', odoo: '‚Äî' },
            { laravel: '5. Order ships ‚Üí trigger SERP ship ‚Üí POST /api/orders/ship', odoo: '‚Äî' },
            { laravel: '6. Store response: cost_unit on items/component_orders', odoo: '‚Äî' },
            {
              laravel: '7. Order cancelled ‚Üí trigger SERP cancel ‚Üí POST /api/orders/cancel',
              odoo: '‚Äî',
            },
          ],
          dataOwnership: [
            { data: 'ec_order.serp_picking_id', laravel: 'Owner', odoo: '‚Äî' },
            { data: 'items.cost_unit', laravel: 'Owner (written by SERP)', odoo: '‚Äî' },
            { data: 'component_orders.cost_unit', laravel: 'Owner (written by SERP)', odoo: '‚Äî' },
          ],
          dbChanges: [
            {
              table: 'ec_order (ADD columns)',
              purpose: 'Link to SERP inventory operations',
              columns: 'serp_picking_id (BIGINT), serp_state (VARCHAR 20)',
            },
            {
              table: 'items (ADD columns)',
              purpose: 'Track inventory moves and FIFO cost',
              columns: 'stock_move_id (BIGINT), cost_unit (DECIMAL 12,4)',
            },
            {
              table: 'component_orders (ADD columns)',
              purpose: 'Track inventory moves and FIFO cost',
              columns: 'stock_move_id (BIGINT), cost_unit (DECIMAL 12,4)',
            },
          ],
          implementation: [
            '--- REQUIREMENTS ---',
            '1. Detect custom branding orders (merchandise_selections IS NOT NULL)',
            '2. Parse merchandise_selections JSON ‚Üí create component_orders records',
            '3. On order created: Call SERP /api/orders/reserve ‚Üí store picking_id, stock_move_id',
            '4. On order ships: Call SERP /api/orders/ship ‚Üí store cost_unit',
            '5. On order cancelled: Call SERP /api/orders/cancel',
            '6. Handle API failures gracefully (retry transient errors, alert on persistent failures)',
            '--- MERCHANDISE_SELECTIONS FORMAT ---',
            'ec_order.merchandise_selections stores custom merchandise from proposal branding JSON:',
            'Product details: component_id, sku, quantity, unit_price',
            'Box overrides: if custom merchandise requires different box than standard',
            'Inventory adjustments: add back standard box, deduct actual box used',
            'Example component: <code>{ "component_id": 123, "sku": "CB-RIBBON-RED", "quantity": 50, "unit_price": 0.25 }</code>',
            'Example component: <code>{ "component_id": 456, "sku": "CB-BOX-SM", "quantity": 100, "unit_price": 1.50 }</code>',
            'Full structure TBD - aligned with sleeve branding implementation (see sleeve planning doc)',
            '--- SERP API: POST /api/orders/reserve ---',
            'Request: <code>{ "order_id": 12345, "items": [{ "component_id": 123, "quantity": 50 }, ...] }</code>',
            'Response: <code>{ "picking_id": 789, "moves": [{ "component_id": 123, "stock_move_id": 1001 }, ...] }</code>',
            '--- SERP API: POST /api/orders/ship ---',
            'Request: <code>{ "order_id": 12345, "picking_id": 789 }</code>',
            'Response: <code>{ "costs": [{ "component_id": 123, "cost_unit": 0.23 }, ...] }</code>',
            '--- SERP API: POST /api/orders/cancel ---',
            'Request: <code>{ "order_id": 12345, "picking_id": 789 }</code>',
            'Response: <code>{ "success": true }</code>',
            '--- IMPLEMENTATION APPROACH ---',
            'Laravel developer chooses pattern: queue, observer, events, scheduled job, etc.',
            'Can be sync or async - SERP APIs are idempotent',
            '--- API INTEGRATION STRATEGY ---',
            'Weeks 1-4: Stub SERP API calls with mock responses (Phase 1 APIs not ready yet)',
            'Week 5: Switch stubs to real SERP /api/orders/* endpoints (Phase 1 builds these in weeks 6-7)',
            'Week 6: Integration testing against live SERP APIs with real inventory data',
          ],
          keyPoint:
            'Laravel developer task (parallel with Phase 1). Builds queue processor for CUSTOM BRANDING ONLY. Phase 6 expands to all orders.',
        },
        {
          id: 3,
          name: 'PO/Bill UI + Odoo Sync + Data Migration',
          shortName: 'PO UI+Sync',
          weeks: 8,
          deps: [1, 2],
          color: '#198754',
          milestone: 'PO + Bill System Live',
          goal: 'Build frontend UI for PO/Bill management. Implement Odoo XML-RPC sync. Migrate existing PO data from Odoo. Add email notifications and activity logging. Backend services already built in Phase 1.',
          goals: [
            'Build PO management UI: create, edit, receive, track POs',
            'Build vendor bill UI: 3-way matching workflow (PO ‚Üí Receipt ‚Üí Vendor Invoice)',
            'Implement Odoo XML-RPC sync service + sync queue',
            'Migrate existing data: 1.8K POs + 16K lines + 1.6K bills from Odoo',
            'Add email notifications for supplier communication',
            'Integrate activity logging (mail_message) into UI',
            'Train purchasing team and run parallel validation',
          ],
          tasks: [
            {
              name: 'Migrate Odoo data: suppliers, components, POs, bills',
              startWeek: 1,
              duration: 2,
            },
            {
              name: 'Build Odoo XML-RPC sync service + sync queue',
              startWeek: 2,
              duration: 2,
            },
            {
              name: 'Build PO UI: create, edit, list, detail views',
              startWeek: 3,
              duration: 2,
            },
            {
              name: 'Build receiving UI: dock receipt ‚Üí inspection ‚Üí inventory receipt',
              startWeek: 5,
              duration: 1,
            },
            {
              name: 'Build vendor bill UI: 3-way matching workflow',
              startWeek: 5,
              duration: 2,
            },
            {
              name: 'Add email notifications + activity log integration',
              startWeek: 6,
              duration: 1,
            },
            {
              name: 'Train purchasing team + parallel run validation',
              startWeek: 7,
              duration: 1,
            },
            {
              name: 'Cutover + stabilization',
              startWeek: 8,
              duration: 1,
            },
          ],
          workflow: [
            { laravel: 'Create PO (draft or sent) ‚Äî date_order captured', odoo: '‚Äî' },
            { laravel: 'Set date_planned (expected arrival date)', odoo: '‚Äî' },
            { laravel: 'Email supplier or download PO as PDF', odoo: '‚Äî' },
            { laravel: 'Dock receipt (no inventory update yet)', odoo: '‚Äî' },
            { laravel: 'Inspection ‚Üí assign warehouse location ‚Üí inventory receipt', odoo: '‚Äî' },
            {
              laravel: 'Inventory receipt: effective_date set, sync triggered',
              odoo: 'Push: PO header + lines + stock_picking (receipt) ‚Üí inventory updated',
              sync: true,
            },
            { laravel: 'Mark backorders for future arrival (accept or cancel later)', odoo: '‚Äî' },
            { laravel: '--- 3-WAY MATCHING WORKFLOW (bills in SERP) ---', odoo: '---' },
            {
              laravel: '1. System creates DRAFT BILL from receipt (qty_received √ó price_unit)',
              odoo: '‚Äî',
            },
            { laravel: '2. Vendor sends invoice externally (email/mail)', odoo: '‚Äî' },
            { laravel: '3. Accountant compares draft bill vs vendor invoice', odoo: '‚Äî' },
            { laravel: '4a. If match: Accountant finalizes bill ‚Üí state=posted', odoo: '‚Äî' },
            { laravel: '4b. If mismatch: Kick back to ops ‚Üí reconcile with vendor', odoo: '‚Äî' },
            { laravel: '5. Finalized bill stored in SERP with line-item detail', odoo: '‚Äî' },
          ],
          dataOwnership: [
            { data: 'Purchase orders', laravel: 'Owner', odoo: 'Created on arrival (for billing)' },
            { data: 'PO line items', laravel: 'Owner', odoo: 'Created on arrival (for billing)' },
            { data: 'Backorders', laravel: 'Owner', odoo: '‚Äî' },
            { data: 'Suppliers (156 vendors)', laravel: 'Owner', odoo: 'Mapping (partner_id)' },
            {
              data: 'Supplier-product links (which products from which supplier)',
              laravel: 'Owner',
              odoo: '‚Äî',
            },
            { data: 'Receiving inspection records', laravel: 'Owner', odoo: '‚Äî' },
            { data: 'Vendor bills', laravel: 'Owner', odoo: '‚Äî' },
            {
              data: 'Inventory quantities',
              laravel: '‚Äî',
              odoo: 'Owner (stock_quant) ‚Äî migrates to SERP in later part',
            },
          ],
          implementation: [
            '--- NOTE: Backend services (PO/inventory/FIFO) already built in Phase 1 ---',
            '--- DATA MIGRATION (export from Odoo, import to SERP) ---',
            'Week 1-2: Import historical data FIRST (POs, suppliers, bills) ‚Äî no sync needed for old data',
            'Week 2-3: Build Odoo sync service for ONGOING operations (new POs going forward)',
            'Inventory quantities (stock_quant) stay in Odoo for Part 1 ‚Äî migrated in a later part when SERP becomes inventory owner',
            'Export suppliers (res_partner) with vendor_rank > 0',
            'Export components (product_product + product_template) with type=product',
            'Export 1,846 POs + 16,139 lines with qty_received/qty_invoiced status',
            'Export 1,569 vendor bills from account_move',
            'Data cleanup: audit over-receipted lines and cancelled POs with active moves',
            'Receipt validation with warehouse team before go-live',
            'Migration scripts with dry-run mode and rollback capability',
            '--- ODOO XML-RPC SYNC (core infrastructure for ALL phases) ---',
            'Build OdooSyncService: XML-RPC client for purchase_order, stock_picking, account_move',
            'Async queue pattern: SERP writes locally first, then queues Odoo sync job',
            'Odoo sync MUST succeed: retry with exponential backoff (1s, 2s, 4s, 8s, max 5 min)',
            'Dead letter queue: after N failures, move to DLQ for manual review',
            'Sync status tracking: each record has sync_status (pending/synced/failed/retrying)',
            'Circuit breaker: if Odoo is down (5+ consecutive failures), pause queue and alert',
            'Reconciliation job: daily job compares SERP vs Odoo, flags discrepancies',
            'Admin dashboard: view failed syncs, retry individual items, bulk retry',
            'REUSED IN ALL PHASES: MO sync, adjustment sync, BOM sync, location sync, product sync',
            '--- FRONTEND UI ---',
            'PO creation form: supplier, components, quantities, expected dates',
            'Draft PO workflow: save without sending to vendor',
            'Two-stage receiving UI: dock receipt ‚Üí inspection ‚Üí inventory receipt',
            'Location assignment on receipt (which warehouse bin receives goods)',
            'Partial receipt workflow with delta sync tracking',
            'Backorder UI: mark future arrivals, accept or cancel later',
            'Bill creation UI: draft bill from receipt (qty_received √ó price_unit)',
            '3-way match UI: compare draft bill ‚Üî vendor invoice ‚Üî original PO',
            'Activity log UI: timeline of PO events (created, received, billed)',
            '--- EMAIL & NOTIFICATIONS ---',
            'Send PO to supplier via email (with PDF attachment)',
            'Warehouse alerts: backorder notifications, overdue receipts',
            'Finance alerts: bills ready for review, mismatched amounts',
            '--- EDGE CASES & VALIDATION ---',
            'Backorder workflow: split PO into received + pending shipments',
            'Partial receipt handling: update qty_received, sync delta to Odoo',
            'Bill rejection workflow: accountant flags mismatch, ops reconciles with vendor',
            'Over-receipt prevention: validate qty_received ‚â§ ordered quantity (with override)',
          ],
          dbChanges: [
            {
              table: 'üìã No New Migrations (uses Phase 1 schema)',
              purpose: 'All tables created in Phase 1 migrations 001-010',
              columns: '',
            },
            {
              table: 'purchase_orders (POPULATE)',
              purpose: 'Import 1,846 POs from Odoo purchase.order',
              columns: 'odoo_id, date_order, date_planned, effective_date populated',
            },
            {
              table: 'purchase_order_line (POPULATE)',
              purpose: 'Import 16,139 PO lines from Odoo',
              columns: 'qty_received, qty_invoiced, odoo_component_id populated',
            },
            {
              table: 'suppliers (POPULATE)',
              purpose: 'Import 289 suppliers from Odoo res.partner',
              columns: 'odoo_partner_id populated',
            },
            {
              table: 'product_supplierinfo (POPULATE)',
              purpose: 'Import 2,600 supplier-product links',
              columns: 'supplier_id, component_id, price, min_qty, delay',
            },
            {
              table: 'account_move (POPULATE)',
              purpose: 'Import 1,569 vendor bills from Odoo',
              columns: 'account_journal_id, supplier_id, state',
            },
            {
              table: 'account_move_line (POPULATE)',
              purpose: 'Import bill line items for 3-way matching',
              columns: 'purchase_order_line_id, component_id',
            },
          ],
          confirmations: [
            'Purchasing team - PO creation and editing workflow',
            'Warehouse team - receipt and inspection process',
            'Finance team - 3-way matching workflow (draft bill vs vendor invoice)',
            'Finance team - bill approval and finalization process',
          ],
          keyPoint:
            'Frontend UI for PO/Bill management + Odoo XML-RPC sync + data migration. Backend services already built in Phase 1.',
        },
      ];

      // Migration events - Part 1 only includes events for phases 1, 2, 3
      const migrationEvents = [
        {
          phase: 1,
          week: 1,
          name: 'Custom Branding Setup',
          desc: 'Create custom branding products and initial inventory in SERP. No Odoo import - built from scratch.',
          tables: [
            'components (custom branding)',
            'stock_quant (custom inventory)',
            'stock_location (warehouse bins)',
          ],
          color: '#e67e22',
        },
        {
          phase: 3,
          week: 4,
          name: 'Import PO/Supplier Data',
          desc: 'After schema design finalized, import PO and supplier data into SERP tables. Development continues against real data.',
          tables: [
            'purchase_order (1.8K)',
            'purchase_order_line (16K)',
            'res_partner (289 suppliers)',
            'product_supplierinfo (2.6K)',
            'account_move (vendor bills only)',
          ],
          color: '#198754',
        },
        {
          phase: 3,
          week: 8,
          name: 'Run Migration Scripts',
          desc: 'Execute data cleanup, transformation, and validation scripts. Link SERP components to Odoo products.',
          tables: [
            'Data cleanup',
            'qty_received/qty_invoiced',
            'supplier-product links',
            'bill line matching',
          ],
          color: '#198754',
        },
      ];

      function addDays(d, n) {
        const r = new Date(d);
        r.setDate(r.getDate() + n);
        return r;
      }
      function addWeeks(d, w) {
        return addDays(d, w * 7);
      }
      function fmt(d) {
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }
      function fmtFull(d) {
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }

      function calcSchedules() {
        const start = new Date(project.startDate);
        const ends = new Map();
        return phases.map((p) => {
          let s = start;
          p.deps.forEach((id) => {
            const e = ends.get(id);
            if (e && e > s) s = e;
          });
          const e = addWeeks(s, p.weeks);
          ends.set(p.id, e);
          return {
            phase: p,
            start: s,
            end: e,
            isParallel: p.parallelWith && p.parallelWith.length > 0,
          };
        });
      }

      function renderPhaseDetail(sched) {
        const p = sched.phase;
        const start = sched.start;
        let html = `<div class="phase-detail">
        <div class="phase-header" style="border-left-color:${p.color}" onclick="togglePhase(${p.id})">
          <h2><span class="toggle">‚ñ∂</span> Phase ${p.id}: ${p.name}</h2>
          <div class="phase-meta-info">${fmtFull(sched.start)} ‚Üí ${fmtFull(sched.end)} (${p.weeks} weeks)${sched.isParallel ? ' ‚Ä¢ Runs in parallel' : ''}</div>
          <div class="phase-goal-text">${p.goal}</div>
        </div>
        <div class="phase-content" id="phase-content-${p.id}">`;

        // Goals
        if (p.goals && p.goals.length) {
          html += `<div class="section"><h3 style="border-color:${p.color}">Goals</h3><ul>`;
          p.goals.forEach((g) => (html += `<li>${g}</li>`));
          html += `</ul></div>`;
        }

        // Workflow
        html += `<div class="section"><h3 style="border-color:${p.color}">How It Works</h3>`;
        if (Array.isArray(p.workflow)) {
          html += `<table class="workflow-table"><tr><th>SERP (Laravel)</th><th style="width:40px"></th><th>Odoo</th></tr>`;
          p.workflow.forEach((row) => {
            if (row.laravel.startsWith('---')) {
              const headerText = row.laravel.replace(/^-+\s*/, '').replace(/\s*-+$/, '');
              html += `<tr><td colspan="3" style="background:${p.color}15;color:${p.color};font-weight:600;text-align:center;padding:12px;border-top:2px solid ${p.color}">${headerText}</td></tr>`;
            } else {
              const rowClass = row.sync ? 'sync-row' : '';
              const arrow = row.sync ? '‚Üí' : '';
              html += `<tr class="${rowClass}"><td>${row.laravel}</td><td class="arrow">${arrow}</td><td>${row.odoo}</td></tr>`;
            }
          });
          html += `</table>`;
        } else {
          Object.entries(p.workflow).forEach(([header, rows]) => {
            html += `<h4>${header}</h4><table class="workflow-table"><tr><th>SERP (Laravel)</th><th style="width:40px"></th><th>Odoo</th></tr>`;
            rows.forEach((row) => {
              if (row.laravel.startsWith('---')) {
                const headerText = row.laravel.replace(/^-+\s*/, '').replace(/\s*-+$/, '');
                html += `<tr><td colspan="3" style="background:${p.color}15;color:${p.color};font-weight:600;text-align:center;padding:12px">${headerText}</td></tr>`;
              } else {
                const rowClass = row.sync ? 'sync-row' : '';
                const arrow = row.sync ? '‚Üí' : '';
                html += `<tr class="${rowClass}"><td>${row.laravel}</td><td class="arrow">${arrow}</td><td>${row.odoo}</td></tr>`;
              }
            });
            html += `</table>`;
          });
        }
        if (p.keyPoint)
          html += `<div class="highlight" style="border-color:${p.color}"><strong>${p.keyPoint}</strong></div>`;
        html += `</div>`;

        // Data Ownership
        html += `<div class="section"><h3 style="border-color:${p.color}">Data Ownership</h3>`;
        html += `<table><tr><th>Data</th><th>SERP</th><th>Odoo</th></tr>`;
        p.dataOwnership.forEach((row) => {
          const laravelClass = row.laravel.includes('Owner') ? 'owner-cell' : 'copy-cell';
          const odooClass = row.odoo.includes('Owner') ? 'owner-cell' : 'copy-cell';
          html += `<tr><td>${row.data}</td><td class="${laravelClass}">${row.laravel}</td><td class="${odooClass}">${row.odoo}</td></tr>`;
        });
        html += `</table></div>`;

        // Database Changes
        if (p.dbChanges && p.dbChanges.length) {
          html += `<div class="section"><h3 style="border-color:${p.color}">Database Changes</h3>`;
          html += `<table><tr><th>Table</th><th>Purpose</th><th>Links To</th></tr>`;
          p.dbChanges.forEach((row) => {
            const isMigrationHeader = row.table.startsWith('üìã');
            const rowClass = isMigrationHeader ? 'migration-header-row' : 'table-row';
            const tableCell = isMigrationHeader
              ? `<td class="table-name">${row.table}</td>`
              : `<td class="table-name">${row.table}</td>`;
            const purposeCell = `<td class="purpose">${row.purpose || ''}</td>`;
            const columnsCell = isMigrationHeader
              ? `<td class="columns"></td>`
              : `<td class="columns">${row.columns}</td>`;
            html += `<tr class="${rowClass}">${tableCell}${purposeCell}${columnsCell}</tr>`;
          });
          html += `</table></div>`;
        }

        // Implementation
        html += `<div class="section"><h3 style="border-color:${p.color}">Implementation Details</h3>`;
        if (Array.isArray(p.implementation)) {
          html += `<ul>`;
          p.implementation.forEach((item) => {
            if (item.startsWith('---') && item.endsWith('---')) {
              const headerText = item.replace(/^-+\s*/, '').replace(/\s*-+$/, '');
              html += `</ul><h4 style="margin-top:20px;color:${p.color}">${headerText}</h4><ul>`;
            } else {
              html += `<li>${item}</li>`;
            }
          });
          html += `</ul>`;
        } else {
          Object.entries(p.implementation).forEach(([header, items]) => {
            html += `<h4>${header}</h4><ul>`;
            items.forEach((item) => {
              if (item.startsWith('---')) {
                const headerText = item.replace(/^-+\s*/, '').replace(/\s*-+$/, '');
                html += `</ul><h4 style="color:${p.color}">${headerText}</h4><ul>`;
              } else {
                html += `<li>${item}</li>`;
              }
            });
            html += `</ul>`;
          });
        }
        html += `</div>`;

        // Cutover Checklist
        if (p.cutoverChecklist && p.cutoverChecklist.length) {
          html += `<div class="section"><h3 style="border-color:${p.color}">Cutover Checklist</h3><ul>`;
          p.cutoverChecklist.forEach((item) => (html += `<li>‚òê ${item}</li>`));
          html += `</ul></div>`;
        }

        // Confirmations
        if (p.confirmations && p.confirmations.length) {
          html += `<div class="section"><h3 style="border-color:${p.color}">Team Confirmations Before Launch</h3><ul>`;
          p.confirmations.forEach((item) => (html += `<li>${item}</li>`));
          html += `</ul></div>`;
        }

        // Timeline
        html += `<div class="section"><h3 style="border-color:${p.color}">Timeline</h3>`;
        html += `<div class="gantt-container"><div class="gantt-header"><div class="gantt-label">Task</div><div class="gantt-weeks">`;
        for (let w = 1; w <= p.weeks; w++) {
          const weekStart = addDays(start, (w - 1) * 7);
          html += `<div class="week-col">W${w}<br><span class="week-dates">${fmt(weekStart)}</span></div>`;
        }
        html += `</div></div>`;
        p.tasks.forEach((task) => {
          const left = ((task.startWeek - 1) / p.weeks) * 100;
          const width = (task.duration / p.weeks) * 100;
          html += `<div class="gantt-row"><div class="task-label">${task.name}</div>`;
          html += `<div class="task-track">${Array(p.weeks).fill('<div class="task-cell"></div>').join('')}`;
          html += `<div class="task-bar" style="left:${left}%;width:${width}%;background:${p.color}">${task.duration}w</div></div></div>`;
        });
        html += `</div></div>`;

        html += `</div></div>`;
        return html;
      }

      function togglePhase(id) {
        const content = document.getElementById(`phase-content-${id}`);
        const header = content.previousElementSibling;
        content.classList.toggle('hide');
        header.classList.toggle('collapsed');
      }

      function render() {
        const scheds = calcSchedules();
        const start = new Date(project.startDate);
        const end = scheds.reduce((max, s) => (s.end > max ? s.end : max), scheds[0].end);

        document.getElementById('meta').textContent =
          `${fmtFull(start)} ‚Üí ${fmtFull(end)} | ${project.preparedBy}`;

        const totalWeeks = Math.ceil((end - start) / (7 * 24 * 60 * 60 * 1000));
        const totalTasks = phases.reduce((s, p) => s + p.tasks.length, 0);
        document.getElementById('summary').innerHTML = `
        <div class="summary-card"><div class="value">${phases.length}</div><div class="label">Phases</div></div>
        <div class="summary-card"><div class="value">${totalWeeks}</div><div class="label">Weeks</div></div>
        <div class="summary-card"><div class="value">${totalTasks}</div><div class="label">Tasks</div></div>
        <div class="summary-card"><div class="value">${fmt(end)}</div><div class="label">Target</div></div>
      `;

        const months = [];
        let cur = new Date(start);
        while (cur <= end) {
          months.push(cur.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));
          cur = new Date(cur.getFullYear(), cur.getMonth() + 1, 1);
        }
        document.getElementById('months').innerHTML = months
          .map((m) => `<div class="month-col">${m}</div>`)
          .join('');

        const totalDays = (end - start) / (24 * 60 * 60 * 1000);
        document.getElementById('timeline').innerHTML = scheds
          .map((s) => {
            const left = ((s.start - start) / (24 * 60 * 60 * 1000) / totalDays) * 100;
            const width = ((s.end - s.start) / (24 * 60 * 60 * 1000) / totalDays) * 100;
            const parallelLabel = s.isParallel ? ' ‚à•' : '';
            return `<div class="phase-row">
          <div class="phase-label">Phase ${s.phase.id}: ${s.phase.shortName}${parallelLabel}</div>
          <div class="phase-track">
            <div class="phase-bar" style="left:${left}%;width:${width}%;background:${s.phase.color}">
              <span>${s.phase.name}</span>
              <span class="phase-dates">${fmt(s.start)} ‚Üí ${fmt(s.end)}</span>
            </div>
          </div>
        </div>`;
          })
          .join('');

        // Render migration events with calculated dates
        document.getElementById('migration-events').innerHTML = migrationEvents
          .map((evt) => {
            const phaseSched = scheds.find((s) => s.phase.id === evt.phase);
            const eventDate = addDays(phaseSched.start, (evt.week - 1) * 7);
            return `<div class="migration-event">
          <div class="migration-event-phase" style="color:${evt.color}">Phase ${evt.phase}</div>
          <div class="migration-event-week">Week ${evt.week}<br><span style="font-size:0.8em">${fmt(eventDate)}</span></div>
          <div class="migration-event-info">
            <div class="migration-event-name">${evt.name}</div>
            <div class="migration-event-desc">${evt.desc}</div>
            <div class="migration-event-tables">${evt.tables.map((t) => `<code>${t}</code>`).join('')}</div>
          </div>
        </div>`;
          })
          .join('');

        document.getElementById('milestones').innerHTML = scheds
          .map(
            (s) => `
        <div class="milestone-item">
          <div class="milestone-dot" style="background:${s.phase.color}"></div>
          <div class="milestone-info">
            <div class="milestone-name">${s.phase.milestone}</div>
            <div class="milestone-phase">Phase ${s.phase.id}</div>
          </div>
          <div class="milestone-date">${fmtFull(s.end)}</div>
        </div>
      `
          )
          .join('');

        document.getElementById('phases-detail').innerHTML = scheds
          .map((s) => renderPhaseDetail(s))
          .join('');
      }

      render();
    </script>
  </body>
</html>
