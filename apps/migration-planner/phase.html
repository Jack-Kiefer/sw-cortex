<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phase Details</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f8f9fa;
        color: #333;
        min-height: 100vh;
        line-height: 1.6;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
      }

      .breadcrumb {
        margin-bottom: 20px;
        font-size: 0.9em;
      }
      .breadcrumb a {
        color: #198754;
        text-decoration: none;
        font-weight: 500;
      }
      .breadcrumb a:hover {
        text-decoration: underline;
      }
      .breadcrumb span {
        color: #6c757d;
        margin: 0 8px;
      }

      header {
        padding: 24px;
        background: #fff;
        border-radius: 12px;
        margin-bottom: 24px;
        border-left: 5px solid;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      header h1 {
        font-size: 1.5em;
        margin-bottom: 8px;
        color: #212529;
      }
      .phase-meta {
        color: #6c757d;
        font-size: 0.9em;
        margin-bottom: 12px;
      }
      .phase-goal {
        background: #f8f9fa;
        padding: 14px;
        border-radius: 8px;
        color: #495057;
        font-size: 0.95em;
      }

      .section {
        background: #fff;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
      }
      .section h2 {
        font-size: 1.1em;
        margin-bottom: 16px;
        padding-bottom: 10px;
        border-bottom: 2px solid;
      }
      .section h3 {
        font-size: 0.95em;
        margin: 16px 0 8px;
        color: #495057;
      }
      .section h3:not(:first-of-type) {
        border-top: 1px solid #e9ecef;
        padding-top: 16px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin: 12px 0;
        font-size: 0.9em;
      }
      th,
      td {
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
      }
      th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
      }
      .owner-cell {
        color: #198754;
        font-weight: 600;
      }
      .copy-cell {
        color: #6c757d;
      }

      .workflow-table th:first-child {
        background: #e8f5e9;
        color: #198754;
      }
      .workflow-table th:last-child {
        background: #f3e5f5;
        color: #7b1fa2;
      }
      .workflow-table .sync-row {
        background: #fff3cd;
      }
      .workflow-table .arrow {
        text-align: center;
        color: #6c757d;
      }

      ul {
        margin: 8px 0;
        padding-left: 24px;
      }
      li {
        margin: 6px 0;
      }

      .highlight {
        background: #fff3cd;
        padding: 12px 16px;
        border-left: 4px solid;
        margin: 16px 0;
        font-weight: 500;
      }

      code {
        background: #f1f3f5;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.85em;
      }

      .gantt-container {
        overflow-x: auto;
        margin-top: 16px;
      }
      .gantt-header {
        display: flex;
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 8px;
        min-width: 800px;
      }
      .gantt-label {
        width: 280px;
        min-width: 280px;
        padding: 10px;
        font-weight: 600;
        color: #495057;
        font-size: 0.85em;
      }
      .gantt-weeks {
        display: flex;
        flex: 1;
      }
      .week-col {
        flex: 1;
        text-align: center;
        padding: 8px 4px;
        font-size: 0.75em;
        font-weight: 600;
        color: #495057;
        border-left: 1px solid #e9ecef;
        background: #f8f9fa;
      }
      .week-col:first-child {
        border-left: none;
      }
      .week-dates {
        font-size: 0.7em;
        color: #6c757d;
        font-weight: 400;
      }

      .gantt-row {
        display: flex;
        align-items: center;
        min-height: 36px;
        border-bottom: 1px solid #f1f3f5;
        min-width: 800px;
      }
      .gantt-row:hover {
        background: #f8f9fa;
      }
      .task-label {
        width: 280px;
        min-width: 280px;
        padding: 6px 10px;
        font-size: 0.85em;
        color: #495057;
      }
      .task-track {
        display: flex;
        flex: 1;
        position: relative;
        height: 26px;
      }
      .task-cell {
        flex: 1;
        border-left: 1px solid #f1f3f5;
      }
      .task-cell:first-child {
        border-left: none;
      }
      .task-bar {
        position: absolute;
        height: 20px;
        top: 3px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7em;
        font-weight: 500;
        color: white;
      }

      .nav-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
      }
      .nav-btn {
        padding: 12px 20px;
        background: #fff;
        border-radius: 8px;
        text-decoration: none;
        color: #495057;
        font-weight: 500;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        transition: all 0.2s;
      }
      .nav-btn:hover {
        background: #f8f9fa;
        transform: translateY(-1px);
      }
      .nav-btn.disabled {
        opacity: 0.4;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="breadcrumb">
        <a href="index.html">Migration Plan</a><span>/</span
        ><span id="breadcrumb-phase">Phase</span>
      </div>

      <header id="header">
        <h1 id="title">Loading...</h1>
        <div class="phase-meta" id="meta"></div>
        <div class="phase-goal" id="goal"></div>
      </header>

      <div id="content"></div>

      <div class="nav-buttons">
        <a href="#" class="nav-btn" id="prev-btn">← Previous</a>
        <a href="#" class="nav-btn" id="next-btn">Next →</a>
      </div>
    </div>

    <script>
      const PROJECT_START = '2026-02-02';

      const phases = [
        {
          id: 1,
          name: 'Purchase Orders & Bills',
          shortName: 'POs+Bills',
          weeks: 10,
          deps: [],
          color: '#198754',
          goal: 'Move all PO creation, arrivals, and vendor bills to SERP. Bills are created MANUALLY after vendor invoice received (not auto-generated). On arrival, push FULL PO (header + lines + receipt) to Odoo for inventory updates.',
          goals: [
            'Move purchase order management from Odoo to SERP',
            'Enable purchasing team to create, edit, and track POs in one place',
            'Automate inventory updates in Odoo when goods are received',
            'Preserve manual bill creation workflow (accountant creates bill after receiving vendor invoice)',
            'Implement 3-way matching: PO → Receipt → Vendor Invoice reconciliation',
          ],
          tasks: [
            { name: 'Design: PO + Bills database schema and plan UX', startWeek: 1, duration: 1 },
            {
              name: 'Build PO views, forms, and arrival tracking UI',
              startWeek: 2,
              duration: 3,
            },
            { name: 'Build Odoo XML-RPC sync for inventory on receipt', startWeek: 5, duration: 1 },
            { name: 'Build email supplier communication service', startWeek: 6, duration: 1 },
            { name: 'Build bill creation from PO arrivals', startWeek: 7, duration: 1 },
            {
              name: 'Migration scripts for existing data (POs + lines + bills + cleanup)',
              startWeek: 8,
              duration: 1,
            },
            {
              name: 'Purchasing/Finance UAT, receipt validation, switchover + rollback plan',
              startWeek: 9,
              duration: 1,
            },
            { name: 'Buffer / stabilization', startWeek: 10, duration: 1 },
          ],
          workflow: [
            { laravel: 'Create PO (draft or sent) — date_order captured', odoo: '—' },
            { laravel: 'Set date_planned (expected arrival date)', odoo: '—' },
            { laravel: 'Email supplier or download PO as PDF', odoo: '—' },
            { laravel: 'Dock receipt (no inventory update yet)', odoo: '—' },
            { laravel: 'Inspection → assign warehouse location → inventory receipt', odoo: '—' },
            {
              laravel: 'Inventory receipt: effective_date set, sync triggered',
              odoo: 'Push: PO header + lines + stock_picking (receipt) → inventory updated',
              sync: true,
            },
            { laravel: 'Mark backorders for future arrival (accept or cancel later)', odoo: '—' },
            { laravel: '--- 3-WAY MATCHING WORKFLOW (bills in SERP) ---', odoo: '---' },
            {
              laravel: '1. System creates DRAFT BILL from receipt (qty_received × price_unit)',
              odoo: '—',
            },
            { laravel: '2. Vendor sends invoice externally (email/mail)', odoo: '—' },
            { laravel: '3. Accountant compares draft bill vs vendor invoice', odoo: '—' },
            { laravel: '4a. If match: Accountant finalizes bill → state=posted', odoo: '—' },
            { laravel: '4b. If mismatch: Kick back to ops → reconcile with vendor', odoo: '—' },
            { laravel: '5. Finalized bill stored in SERP with line-item detail', odoo: '—' },
          ],
          dataOwnership: [
            { data: 'Purchase orders', laravel: 'Owner', odoo: 'Created on arrival (for billing)' },
            { data: 'PO line items', laravel: 'Owner', odoo: 'Created on arrival (for billing)' },
            { data: 'Backorders', laravel: 'Owner', odoo: '—' },
            { data: 'Suppliers (156 vendors)', laravel: 'Owner', odoo: 'Mapping (partner_id)' },
            {
              data: 'Supplier-product links (which products from which supplier)',
              laravel: 'Owner',
              odoo: '—',
            },
            { data: 'Receiving inspection records', laravel: 'Owner', odoo: '—' },
            { data: 'Vendor bills', laravel: 'Owner', odoo: '—' },
            { data: 'Inventory quantities', laravel: '—', odoo: 'Owner (stock_quant)' },
          ],
          dbChanges: [
            // --- CHATTER SYSTEM (Migration 001) ---
            {
              table: 'entity_message',
              purpose:
                'Activity log for POs, bills, receipts - tracks comments, notes, and system events',
              columns: 'entity_type, entity_id, message_type, subtype, subject, body, author_id',
            },
            {
              table: 'entity_field_change',
              purpose:
                'Audit trail - tracks what changed, old value vs new value, linked to messages',
              columns: 'message_id, field_name, old_value, new_value',
            },
            {
              table: 'entity_attachment',
              purpose: 'File attachments on POs/bills (vendor invoices, shipping docs, etc.)',
              columns: 'entity_type, entity_id, message_id, filename, storage_path',
            },
            {
              table: 'message_subtype',
              purpose:
                'Predefined message types (created, updated, RFQ sent, goods received, etc.)',
              columns: 'name, description, entity_type, is_default — seeded with PO/bill subtypes',
            },
            // --- SUPPLIERS (Migration 004) ---
            {
              table: 'suppliers',
              purpose: 'Link SERP vendors to Odoo partners for bi-directional sync',
              columns:
                'odoo_partner_id (sync link), supplier_rank (priority 1=preferred), vat (tax ID), address fields',
            },
            // --- LOCATIONS (Migration 005) ---
            {
              table: 'locations',
              purpose: 'Link SERP warehouse facilities to Odoo warehouse/location IDs',
              columns: 'odoo_warehouse_id, odoo_location_id, active',
            },
            // --- PURCHASE ORDERS (Migration 008) ---
            {
              table: 'purchase_orders',
              purpose:
                'PO lifecycle tracking with Odoo-compatible workflow and THREE CRITICAL DATE FIELDS',
              columns: 'odoo_id, name, state (draft→sent→purchase→done), invoice_status, amount_*',
            },
            {
              table: 'purchase_orders (dates)',
              purpose: '⚠️ THREE DATE FIELDS - understand the difference!',
              columns:
                'date_order (CREATED), date_planned (EXPECTED arrival), effective_date (ACTUAL arrival - USE FOR VARIANCE)',
            },
            {
              table: 'purchase_order_line',
              purpose: 'Line items with quantity tracking for partial receipts and billing',
              columns:
                'product_qty (ordered), qty_received (arrived), qty_invoiced (billed), price_unit',
            },
            {
              table: 'purchase_order_line (product links)',
              purpose: 'Dual-link products: SERP component_id + Odoo odoo_product_id for sync',
              columns: 'component_id (SERP FK), odoo_product_id (Odoo FK)',
            },
            // --- BILLS (Migration 009) ---
            {
              table: 'account_journal',
              purpose:
                'Define journal types that categorize transactions (Vendor Bills, Inventory Valuation, etc.)',
              columns: 'name, code (BILL, STJ), type (purchase, sale, general), default_account_id',
            },
            {
              table: 'account_move',
              purpose:
                'Vendor bills - MANUAL creation after vendor invoice received (3-way matching)',
              columns:
                'name (bill #), ref (VENDOR invoice #), state (draft→posted), payment_state, amount_*',
            },
            {
              table: 'account_move_line',
              purpose: 'Bill line items linked to PO lines for line-level 3-way matching',
              columns: 'quantity, price_unit, price_subtotal, purchase_line_id (FK to PO line!)',
            },
            {
              table: 'account_move_purchase_order_rel',
              purpose: 'Junction table linking bills to POs (one bill can reference multiple POs)',
              columns: 'account_move_id, purchase_order_id',
            },
          ],
          implementation: [
            'Draft POs (save without sending to vendor)',
            'Two-stage arrival: dock receipt → inspection → inventory receipt',
            'On arrival: push FULL PO (header + lines) + stock_picking to Odoo — accountants can then create bills',
            'Location assignment on receipt (which warehouse bin receives goods)',
            'Supplier communication via email and activity log (similar to Odoo)',
            'Backorder tracking: mark future arrivals, accept or cancel later',
            'Partial arrival with delta sync tracking',
            'Sync error notifications and retry queue for XML-RPC updates',
            '--- THREE CRITICAL DATE FIELDS (understand the difference!) ---',
            '• date_order: When PO was CREATED (auto-populated, audit trail)',
            '• date_planned: EXPECTED arrival date (user-entered for planning)',
            '• effective_date: ACTUAL arrival (NULL until goods received!) — USE THIS FOR INVENTORY VARIANCE',
            'Migrates: 1,846 POs + 16,139 lines with qty_received/qty_invoiced status',
            'Data cleanup: audit over-receipted lines and cancelled POs with active moves',
            'Receipt validation with warehouse team before go-live',
            '--- MANUAL BILL WORKFLOW (bills in SERP) ---',
            'Draft bill created from receipt (qty_received × price_unit)',
            'Accountant receives vendor invoice separately (email/mail)',
            '3-way match: compare draft bill ↔ vendor invoice ↔ original PO',
            'If match: accountant finalizes bill',
            'If mismatch: ops reconciles with vendor before finalizing',
            'Bill tracks qty_invoiced vs qty_received for partial billing',
            'Migrates: 1,569 vendor bills from Odoo account_move',
          ],
          confirmations: [
            'Purchasing team - PO creation and editing workflow',
            'Warehouse team - receipt and inspection process',
            'Finance team - 3-way matching workflow (draft bill vs vendor invoice)',
            'Finance team - bill approval and finalization process',
          ],
          keyPoint:
            'POs + Bills in SERP. On arrival: push full PO + receipt to Odoo (for inventory). Bills created in SERP via 3-way matching. Use effective_date for actual arrival.',
        },
        {
          id: 2,
          name: 'Manufacturing, Adjustments, BOMs, Locations & Products',
          shortName: 'MO+Adj+BOMs+Loc+Prod',
          weeks: 12,
          deps: [1],
          parallelWith: [3],
          color: '#9b59b6',
          goal: 'Build Odoo features in SERP. Users switch to SERP UI, which dual-writes to both Odoo (XML-RPC) and SERP tables (stock_quants). Incremental by feature.',
          goals: [
            'Build features in SERP that replicate Odoo functionality',
            'Users switch to SERP UI for each feature (stop using Odoo UI)',
            'Dual-write: SERP sends XML-RPC to Odoo AND updates SERP shadow tables',
            'stock_quants table is independent (no linkage to component/RM inventory yet)',
            'Incremental rollout: Manufacturing → Adjustments → BOMs → Stock Locations → Product Info',
            'Track COGS correctly throughout transition',
          ],
          tasks: [
            // Manufacturing Orders (Weeks 1-3)
            { name: 'Build manufacturing_orders table and MO UI', startWeek: 1, duration: 1 },
            {
              name: 'Build MO creation, tracking, completion, and scrapping workflow',
              startWeek: 2,
              duration: 1,
            },
            { name: 'Disable MO creation in Odoo, SERP becomes SOT', startWeek: 3, duration: 1 },
            // Inventory Adjustments (Weeks 4-5)
            {
              name: 'Build inventory adjustments in SERP with COGS tracking',
              startWeek: 4,
              duration: 1,
            },
            {
              name: 'Dual-write adjustments to both SERP and Odoo, disable Odoo adjustments',
              startWeek: 5,
              duration: 1,
            },
            // BOMs (Weeks 6-7)
            { name: 'Build BOMs table and BOM management UI in SERP', startWeek: 6, duration: 1 },
            {
              name: 'Migrate BOMs from Odoo, disable BOM editing in Odoo',
              startWeek: 7,
              duration: 1,
            },
            // Stock Locations (Weeks 8-9)
            {
              name: 'Build stock_locations table and location management UI',
              startWeek: 8,
              duration: 1,
            },
            {
              name: 'Migrate locations from Odoo, disable location editing in Odoo',
              startWeek: 9,
              duration: 1,
            },
            // Product Info (Weeks 10-11)
            { name: 'Build product management UI with cost tracking', startWeek: 10, duration: 1 },
            {
              name: 'Migrate products from Odoo, disable product editing in Odoo',
              startWeek: 11,
              duration: 1,
            },
            // Odoo Sync Queue (Week 10-11)
            {
              name: 'Build Odoo sync queue with retry, DLQ, and circuit breaker',
              startWeek: 10,
              duration: 2,
            },
            // Python utility functions (Week 11)
            {
              name: 'Build Python function suite for inventory ops (adjustments, arrivals, COGS)',
              startWeek: 11,
              duration: 1,
            },
            // Final Validation (Week 12)
            { name: 'End-to-end testing and COGS reconciliation', startWeek: 12, duration: 1 },
          ],
          workflow: [
            // Core pattern for all features
            {
              laravel: 'User performs action in SERP UI (stops using Odoo UI)',
              odoo: 'Odoo UI disabled for this feature',
            },
            {
              laravel: 'SERP dual-writes: XML-RPC to Odoo + update stock_quants',
              odoo: 'Receives sync, stays in sync',
              sync: true,
            },
            {
              laravel: 'stock_quants updated independently (not linked to component inventory)',
              odoo: '—',
            },
            // Manufacturing
            { laravel: 'MO created/completed/scrapped in SERP', odoo: 'XML-RPC sync', sync: true },
            // Adjustments
            {
              laravel: 'Inventory adjustment in SERP + COGS tracking',
              odoo: 'XML-RPC sync',
              sync: true,
            },
            // BOMs
            { laravel: 'BOM create/edit in SERP', odoo: 'XML-RPC sync', sync: true },
            // Stock Locations
            { laravel: 'Location management in SERP', odoo: 'XML-RPC sync', sync: true },
            // Products
            { laravel: 'Product management in SERP', odoo: 'XML-RPC sync', sync: true },
          ],
          dataOwnership: [
            { data: 'Manufacturing orders', laravel: 'UI + Owner', odoo: 'Synced via XML-RPC' },
            { data: 'Inventory adjustments', laravel: 'UI + Owner', odoo: 'Synced via XML-RPC' },
            { data: 'BOMs (2,078 total)', laravel: 'UI + Owner', odoo: 'Synced via XML-RPC' },
            { data: 'Stock locations', laravel: 'UI + Owner', odoo: 'Synced via XML-RPC' },
            { data: 'Products (5,809)', laravel: 'UI + Owner', odoo: 'Synced via XML-RPC' },
            {
              data: 'stock_quants (shadow)',
              laravel: 'Owner (independent)',
              odoo: 'Has its own copy',
            },
            { data: 'component_inventory', laravel: 'Unchanged', odoo: '—' },
            { data: 'Valuation layers (COGS)', laravel: 'Owner', odoo: '—' },
          ],
          dbChanges: [
            // --- MANUFACTURING (Migration 002) ---
            {
              table: 'manufacture_orders',
              purpose: 'Track production orders with Odoo workflow (draft→confirmed→progress→done)',
              columns:
                'name, odoo_id, receiver_product_id (OUTPUT), state, bom_id, product_qty, qty_produced, location_src/dest_id',
            },
            // --- BOMs (Migration 003) ---
            {
              table: 'mrp_bom',
              purpose: 'BOM headers - define "recipes" (what components make a product)',
              columns:
                'code, product_id (OUTPUT), type (normal/phantom), consumption, active, odoo_bom_id',
            },
            {
              table: 'mrp_bom_line',
              purpose: 'BOM components - qty of each component needed per 1 unit of output',
              columns: 'bom_id, product_id (component), product_qty, sequence, odoo_bom_line_id',
            },
            // --- INVENTORY CORE (Migration 006) ---
            {
              table: 'stock_location',
              purpose:
                'Hierarchical warehouse locations (bins, zones, areas) - different from SERP "locations" table',
              columns:
                'name, complete_name (path), parent_id, usage (internal/supplier/customer), scrap_location',
            },
            {
              table: 'stock_picking_type',
              purpose: 'Define operation types - how receipts, deliveries, transfers behave',
              columns:
                'name, code (incoming/outgoing/internal/mrp), default_location_src/dest_id, reservation_method',
            },
            {
              table: 'stock_production_lot',
              purpose: 'Lot/batch/serial tracking for inventory (e.g., expiration dates)',
              columns:
                'name (lot #), component_id/receiver_product_id, expiration_date, odoo_lot_id',
            },
            // --- INVENTORY SYSTEM (Migration 007) ---
            {
              table: 'stock_quant',
              purpose:
                '⭐ INVENTORY TRUTH - current on-hand qty per product/location. Available = quantity - reserved',
              columns:
                'component_id/receiver_product_id, location_id, quantity, reserved_quantity, in_date, unit_cost',
            },
            {
              table: 'stock_picking',
              purpose:
                'Warehouse operations (receipts, deliveries, transfers) - groups stock_moves',
              columns:
                'name (WH/IN/00123), origin (PO#), location_id→location_dest_id, state (draft→assigned→done)',
            },
            {
              table: 'stock_move',
              purpose:
                'Individual inventory movements - move X units from A to B. Only state=done updates inventory',
              columns:
                'product_uom_qty (requested), quantity_done (actual), state, picking_id, production_id',
            },
            {
              table: 'stock_move_line',
              purpose:
                'Detailed lines within stock_move - for lot/serial tracking (one move can have multiple lots)',
              columns: 'move_id, lot_id, qty_done, location_id→location_dest_id',
            },
            {
              table: 'stock_valuation_layer',
              purpose:
                '⭐ FIFO COSTING - each receipt creates a layer; consumption decrements oldest first',
              columns:
                'quantity, unit_cost (from PO), remaining_qty (unconsumed), remaining_value (for GL)',
            },
            {
              table: 'product_supplierinfo',
              purpose:
                'Supplier-specific pricing/lead times per product - critical for PO cost calculation',
              columns:
                'supplier_id, component_id, price, min_qty (MOQ), delay (lead time days), case_qty',
            },
            {
              table: 'stock_scrap',
              purpose: 'Track scrapped/damaged inventory - moves stock to scrap location',
              columns:
                'scrap_qty, location_id (from), scrap_location_id (to), production_id (if during MO)',
            },
            {
              table: 'stock_landed_cost',
              purpose: 'Add freight/duties/customs to inventory value after receipt',
              columns:
                'amount_total, state, vendor_bill_id, split_method (equal, by_qty, by_weight)',
            },
            // --- ODOO SYNC QUEUE ---
            {
              table: 'odoo_sync_queue',
              purpose: 'Track pending/failed Odoo syncs with retry logic and dead letter queue',
              columns:
                'entity_type, entity_id, operation (create/update/delete), payload JSON, status (pending/processing/synced/failed/dlq), attempts, last_attempt_at, error_message, created_at',
            },
          ],
          implementation: [
            'Incremental rollout: MO → Adjustments → BOMs → Locations → Products',
            'Pattern: build feature in SERP → users switch to SERP UI → disable Odoo UI',
            'Dual-write on every action: XML-RPC to Odoo + update SERP tables',
            '--- ODOO SYNC QUEUE (critical for reliability) ---',
            '• Async queue pattern: SERP writes locally first, then queues Odoo sync job',
            '• Odoo sync MUST succeed: retry with exponential backoff (1s, 2s, 4s, 8s, max 5 min)',
            '• Dead letter queue: after N failures, move to DLQ for manual review',
            '• Sync status tracking: each record has sync_status (pending/synced/failed/retrying)',
            '• Admin dashboard: view failed syncs, retry individual items, bulk retry',
            '• Circuit breaker: if Odoo is down (5+ consecutive failures), pause queue and alert',
            '• Reconciliation job: daily job compares SERP vs Odoo, flags discrepancies',
            '--- END SYNC QUEUE ---',
            'stock_quants is independent shadow table (NOT linked to component/RM inventory)',
            'Existing component_inventory unchanged during this phase',
            'Manufacturing: MO in SERP, dual-writes to Odoo mrp_production',
            'MO scrapping/cancellation: cancel defective MOs, reverse any partial consumption',
            'Adjustments: adjustment in SERP updates stock_quants + XML-RPC to Odoo stock_move',
            'BOMs: BOM management in SERP, syncs to Odoo mrp_bom',
            'Stock locations: location hierarchy in SERP, syncs to Odoo stock_location',
            'Products: product info in SERP, syncs to Odoo product_product',
            'COGS tracking: valuation layers updated on MO completion and adjustments',
            'Odoo stays in sync but users stop using Odoo UI for migrated features',
            'Python function suite: reusable functions for inventory ops that maintain DB integrity',
            'Functions: make_adjustment(), receive_arrival(), complete_mo(), scrap_mo()',
            'All functions enforce COGS structure, update valuation layers, log transactions',
          ],
          confirmations: [
            'Production team - MO creation and completion workflow',
            'Warehouse team - inventory adjustments and location management',
            'Finance team - COGS calculations and valuation accuracy',
            'Operations team - BOM management and product info',
          ],
          keyPoint:
            'SERP becomes the UI, dual-writes to Odoo. stock_quants is independent (not linked to component inventory yet). Feature-by-feature migration.',
        },
        {
          id: 3,
          name: 'Kits',
          shortName: 'Kits',
          weeks: 10,
          deps: [1],
          parallelWith: [2],
          color: '#3498db',
          goal: 'Migrate phantom BOMs from Odoo to Laravel mrp_bom table. Modify updateInsertKit() to use BOTH existing kits AND Laravel BOMs (additive, not fallback).',
          goals: [
            'Migrate phantom BOMs from Odoo mrp_bom to Laravel mrp_bom table',
            'Modify updateInsertKit() to query BOTH existing kits AND Laravel mrp_bom (additive logic)',
            'Match buyer_products.sku → product_template.default_code → mrp_bom',
            'Create ComponentOrders from BOTH sources - union of kit components + BOM components',
            'Deprecate Odoo phantom BOM lookups',
          ],
          tasks: [
            // Data Migration (Weeks 1-3)
            {
              name: 'Create SERP tables: mrp_bom, mrp_bom_line, product_template',
              startWeek: 1,
              duration: 1,
            },
            {
              name: 'Build migration script: export Odoo phantom BOMs + lines',
              startWeek: 1,
              duration: 1,
            },
            {
              name: 'Run migration: load 265 BOMs + ~800 lines into SERP',
              startWeek: 2,
              duration: 1,
            },
            {
              name: 'Validate migration: verify component mappings, count records',
              startWeek: 2,
              duration: 1,
            },
            // Code Changes (Weeks 3-4)
            {
              name: 'Modify updateInsertKit() for ADDITIVE logic (kit + BOM combined)',
              startWeek: 3,
              duration: 2,
            },
            // Testing (Weeks 5-8)
            {
              name: 'Test order expansion: verify kit + phantom BOM components combined',
              startWeek: 5,
              duration: 2,
            },
            {
              name: 'Parallel run: compare ComponentOrders between systems',
              startWeek: 7,
              duration: 2,
            },
            // Cutover (Weeks 9-10)
            {
              name: 'Cutover: disable Odoo phantom BOM lookups',
              startWeek: 9,
              duration: 1,
            },
            {
              name: 'Monitor and stabilize',
              startWeek: 10,
              duration: 1,
            },
          ],
          workflow: [
            { laravel: '--- DATA MIGRATION (Odoo → SERP, one-time) ---', odoo: '---' },
            {
              laravel: 'Export mrp_bom WHERE type=phantom AND active=true (265 BOMs)',
              odoo: 'Source',
            },
            {
              laravel: 'Export mrp_bom_line for those BOMs (~800 component records)',
              odoo: 'Source',
            },
            { laravel: 'Export product_template for SKU matching (default_code)', odoo: 'Source' },
            {
              laravel: 'Load into SERP mrp_bom + mrp_bom_line + product_template tables',
              odoo: '—',
            },
            { laravel: 'Validate: verify component_id mappings, count records', odoo: '—' },
            { laravel: '--- ADDITIVE LOGIC (do BOTH kits + BOMs) ---', odoo: '---' },
            { laravel: '1. Get existing kit components (if buyer_product has kit)', odoo: '—' },
            { laravel: '2. ALSO query mrp_bom WHERE type=phantom AND active=true', odoo: '—' },
            { laravel: '3. Match: buyer_products.sku = product_template.default_code', odoo: '—' },
            { laravel: '4. Get mrp_bom_line → map product_id to components.odoo_id', odoo: '—' },
            { laravel: '5. UNION both sets of components (kit + BOM)', odoo: '—' },
            {
              laravel: '6. Create ComponentOrders for ALL components from both sources',
              odoo: 'Deprecated',
            },
          ],
          dataOwnership: [
            { data: 'mrp_bom (phantom type)', laravel: 'Owner', odoo: 'Deprecated' },
            { data: 'mrp_bom_line (components)', laravel: 'Owner', odoo: 'Deprecated' },
            { data: 'product_template (SKU matching)', laravel: 'Owner', odoo: 'Deprecated' },
            { data: 'Existing kits table', laravel: 'Owner (unchanged)', odoo: '—' },
          ],
          dbChanges: [
            // --- TABLES CREATED IN SERP (migrated from Odoo) ---
            {
              table: 'mrp_bom (CREATE in SERP)',
              purpose:
                'Phantom BOMs migrated from Odoo. 265 active records. Same schema as Odoo for compatibility.',
              columns:
                'id, code, product_tmpl_id, type (phantom), active, product_qty, product_uom_id, odoo_bom_id (link back to Odoo)',
            },
            {
              table: 'mrp_bom_line (CREATE in SERP)',
              purpose: 'BOM components migrated from Odoo. ~800 records for 265 phantom BOMs.',
              columns:
                'id, bom_id (FK), product_id (→ components.odoo_id), product_qty, sequence, odoo_bom_line_id',
            },
            {
              table: 'product_template (CREATE in SERP)',
              purpose:
                'SKU mapping table. Links buyer_products.sku to mrp_bom via default_code field.',
              columns: 'id, name, default_code (SKU), odoo_product_tmpl_id',
            },
            // --- EXISTING TABLES (unchanged) ---
            {
              table: 'kits (EXISTS - unchanged)',
              purpose: 'Existing Laravel kits table. 1,091 active kits. NOT replaced by mrp_bom.',
              columns: 'Unchanged - both kits AND mrp_bom used together (additive)',
            },
            {
              table: 'component_kits (EXISTS - unchanged)',
              purpose: 'Existing kit-component mappings. Used alongside mrp_bom_line.',
              columns: 'Unchanged - additive logic unions both sources',
            },
          ],
          implementation: {
            'Data Migration (Odoo → SERP)': [
              '--- WHAT GETS MIGRATED ---',
              'mrp_bom: 265 active phantom BOMs (type=phantom, active=true)',
              'mrp_bom_line: ~800 component records linked to those BOMs',
              'product_template: SKU mapping table (default_code = buyer_products.sku)',
              '--- MIGRATION SCRIPT ---',
              'Export from Odoo: mrp_bom JOIN mrp_bom_line JOIN product_template',
              'Transform: map product_id → components.odoo_id for each line',
              'Load into Laravel: mrp_bom + mrp_bom_line tables (same schema as Odoo)',
              'Validate: count records, verify component mappings exist',
              '--- EDGE CASES ---',
              'Zero-qty consumables (tape, labels): preserved with qty=0',
              'Inactive BOMs (511 records): NOT migrated - only active=true',
              'Normal BOMs (977 records): migrated in Phase 2, not this phase',
            ],
            'Code Changes (updateInsertKit)': [
              'ADDITIVE LOGIC: Query BOTH existing kits AND mrp_bom (not fallback)',
              'Step 1: Get kit components if buyer_product has assigned kit',
              'Step 2: Match buyer_products.sku = product_template.default_code',
              'Step 3: Query mrp_bom WHERE product_tmpl_id=X AND type=phantom AND active=true',
              'Step 4: Loop mrp_bom_line → map product_id to components.odoo_id',
              'Step 5: UNION kit components + BOM components (dedupe by component_id if needed)',
              'Step 6: Create ComponentOrder for EACH component from combined set',
              'Deduct inventory from component location (same as existing)',
            ],
            'Odoo Sync (Already Handled)': [
              'ComponentOrders already sync to Odoo via existing /api/odoo/component/prepick endpoint',
              'Odoo polls Laravel, fetches orders where component_imported=0',
              'ComponentResource sends: odoo_id, sku, name, quantity from pivot table',
              'No additional sync code needed - phantom BOM ComponentOrders work automatically',
            ],
            Validation: [
              'Diff report: compare ComponentOrders created by Laravel vs Odoo',
              'Test orders with kits (existing path unchanged)',
              'Test orders without kits (new phantom BOM path)',
              'Verify component mapping: mrp_bom_line.product_id → components.odoo_id',
              'Verify ComponentOrders from phantom BOMs sync to Odoo correctly',
            ],
          },
          confirmations: [
            'Ops - phantom BOM components match expected packaging',
            'Tech - ComponentOrders created correctly for both kit and BOM paths',
          ],
          keyPoint:
            'ADDITIVE: updateInsertKit() uses BOTH existing kits AND Laravel mrp_bom (not fallback). Components from both sources are unioned. SKU matching: buyer_products.sku = product_template.default_code.',
        },
        {
          id: 4,
          name: 'Inventory Management',
          shortName: 'Inventory',
          weeks: 10,
          deps: [2, 3],
          color: '#dc3545',
          goal: 'Make SERP the source of truth for inventory. Create views to expose stock_quant quantities. Build order processing queue. Deprecate Odoo.',
          goals: [
            'Migrate all inventory from Odoo to SERP stock_quant (quantities + FIFO cost layers)',
            'Make stock_quant the single source of truth for inventory',
            'Create inventory views (receiver_product_inventory, component_inventory) that aggregate stock_quant',
            'Update all code to JOIN views instead of reading inventory_qty columns',
            'Build order processing queue (reserve → ship → COGS)',
            'Complete cutover: activate SERP queues, disable Odoo sync',
          ],
          tasks: [
            // Inventory Views (Weeks 1-2)
            {
              name: 'Create inventory views (receiver_product_inventory, component_inventory)',
              startWeek: 1,
              duration: 1,
            },
            {
              name: 'Find and update all code to use inventory views',
              startWeek: 2,
              duration: 1,
            },
            // Order Processing Queue (Weeks 3-5)
            {
              name: 'Build order processing queue (reserve inventory, write stock_move_id)',
              startWeek: 3,
              duration: 1,
            },
            {
              name: 'Build ship processing (FIFO consumption, write cost_unit)',
              startWeek: 4,
              duration: 1,
            },
            {
              name: 'Build cancel processing (release reservations)',
              startWeek: 5,
              duration: 1,
            },
            // Data Migration (Weeks 6-7)
            {
              name: 'Migrate Odoo inventory + FIFO cost layers to SERP stock_quant',
              startWeek: 6,
              duration: 1,
            },
            {
              name: 'Physical count and reconciliation vs migrated data',
              startWeek: 7,
              duration: 1,
            },
            // Cutover (Weeks 8-10)
            {
              name: 'Parallel run: orders processed by both Odoo and SERP',
              startWeek: 8,
              duration: 1,
            },
            {
              name: 'Validate COGS and inventory accuracy',
              startWeek: 9,
              duration: 1,
            },
            {
              name: 'Go-live: disable Odoo, SERP is source of truth',
              startWeek: 10,
              duration: 1,
            },
          ],
          workflow: {
            'Inventory Views': [
              { laravel: 'stock_quant is source of truth for inventory quantities', odoo: '—' },
              {
                laravel:
                  'receiver_product_inventory view aggregates stock_quant by receiver_product_id',
                odoo: '—',
              },
              {
                laravel: 'component_inventory view aggregates stock_quant by component_id',
                odoo: '—',
              },
              { laravel: 'Code JOINs views instead of reading inventory_qty columns', odoo: '—' },
              { laravel: 'Physical count reconciliation before cutover', odoo: 'Final sync' },
            ],
            'Order Flow': [
              { laravel: 'Order created → stock_move_id = NULL', odoo: '—' },
              { laravel: 'SERP queue finds unprocessed (WHERE stock_move_id IS NULL)', odoo: '—' },
              { laravel: 'SERP reserves inventory, writes stock_move_id back', odoo: '—' },
              { laravel: 'Order ships → SERP consumes FIFO, writes cost_unit back', odoo: '—' },
              { laravel: 'Order cancelled before ship → release reservation', odoo: '—' },
            ],
          },
          dataOwnership: [
            { data: 'stock_quant (source of truth)', laravel: 'Owner', odoo: 'Deprecated' },
            {
              data: 'receiver_product_inventory (view)',
              laravel: 'Aggregates stock_quant',
              odoo: '—',
            },
            {
              data: 'component_inventory (view)',
              laravel: 'Aggregates stock_quant',
              odoo: '—',
            },
            { data: 'Order inventory deductions', laravel: 'Owner', odoo: 'Deprecated' },
            { data: 'COGS (cost_unit on items/component_orders)', laravel: 'Owner', odoo: '—' },
          ],
          dbChanges: [
            // --- INVENTORY VIEWS ---
            {
              table: 'receiver_product_inventory (VIEW)',
              purpose:
                'Aggregates stock_quant for finished goods - replaces receiver_products.inventory_qty column',
              columns:
                'receiver_product_id, total_qty, reserved_qty, available_qty (total - reserved)',
            },
            {
              table: 'component_inventory (VIEW)',
              purpose:
                'Aggregates stock_quant for components - replaces components.inventory_qty column',
              columns: 'component_id, total_qty, reserved_qty, available_qty (total - reserved)',
            },
            // --- ORDER LINE ENHANCEMENTS (Migration 010) ---
            {
              table: 'items',
              purpose: 'Link order items to inventory moves + track FIFO cost at fulfillment',
              columns: 'stock_move_id (FK to stock_move), cost_unit (FIFO cost per unit)',
            },
            {
              table: 'component_orders',
              purpose: 'Link component orders to inventory moves + track FIFO cost at fulfillment',
              columns: 'stock_move_id (FK to stock_move), cost_unit (FIFO cost per unit)',
            },
            {
              table: 'ec_order',
              purpose: 'Track order state and link to warehouse picking operations',
              columns:
                'serp_state (pending→confirmed→fulfilled), serp_picking_id (FK to stock_picking)',
            },
            // --- CLEANUP (Migration 011) ---
            {
              table: '❌ DROP legacy tables',
              purpose: 'Remove tables replaced by Odoo-style inventory system',
              columns:
                'serp_audit_logs, component_shelves, supplier_product, raw_materials, raw_material_inventory, rm_inventory_transactions, component_inventory, component_inventory_transactions',
            },
          ],
          implementation: {
            'Inventory Views': [
              'Create receiver_product_inventory view: SELECT receiver_product_id, SUM(quantity), SUM(reserved_quantity) FROM stock_quant GROUP BY receiver_product_id',
              'Create component_inventory view: SELECT component_id, SUM(quantity), SUM(reserved_quantity) FROM stock_quant GROUP BY component_id',
              'Index stock_quant on (receiver_product_id) and (component_id) for view performance',
            ],
            'Code Migration': [
              'Find all code reading receiver_products.inventory_qty → change to JOIN receiver_product_inventory',
              'Find all code reading components.inventory_qty → change to JOIN component_inventory',
              'Update queries, reports, dashboards, APIs that reference inventory columns',
              'Test all inventory-related features with new views',
            ],
            'Database Changes': [
              'items: ADD stock_move_id (BIGINT), cost_unit (DECIMAL 12,4)',
              'component_orders: ADD stock_move_id (BIGINT), cost_unit (DECIMAL 12,4)',
            ],
            'Order Processing Queue': [
              'Queue runs every 5 minutes',
              'Process new orders: find items/component_orders WHERE stock_move_id IS NULL',
              'Fulfill shipped orders: when ec_order.ship_date is set, consume FIFO, write cost_unit',
              'Cancel orders: if cancelled before ship, release reservation',
            ],
            'New Order Processing': [
              'Find ec_order where line items have no stock_move_id',
              'Map items.product_sku → receiver_products',
              'Create stock_picking + stock_move, reserve inventory',
              'Write stock_move_id back to items/component_orders',
            ],
            'Ship Order Processing': [
              'Find orders where ship_date is set but cost_unit is empty',
              'Consume oldest FIFO layers, decrease stock_quant.quantity',
              'Write cost_unit to items/component_orders',
            ],
            'Cancel Order Processing': [
              'Before ship: release reservation, cancel moves',
              'After ship: no action - COGS already recorded',
            ],
            'Data Migration': [
              'Export all receiver_product inventory from Odoo stock_quant to SERP stock_quant',
              'Export all component inventory from Odoo stock_quant to SERP stock_quant',
              'Export FIFO cost layers from Odoo stock_valuation_layer to SERP',
              'Physical count reconciliation to verify migrated quantities',
            ],
          },
          cutoverChecklist: [
            'All inventory data migrated from Odoo to SERP stock_quant',
            'All code updated to use inventory views (no direct inventory_qty reads)',
            'Inventory views created and tested (receiver_product_inventory, component_inventory)',
            'SERP order processing queue built and tested',
            'Parallel run completed (both Odoo and SERP process same orders)',
            'COGS accuracy validated between Odoo and SERP',
            'Physical count reconciliation completed',
            'Legacy tables dropped (serp_audit_logs, component_shelves, etc.)',
            'Odoo order sync disabled',
            'SERP order queue activated as primary',
            'Monitoring/alerting configured for queue failures',
            'Rollback plan documented and tested',
          ],
          confirmations: [
            'Ops - inventory counts match stock_quant',
            'Finance - COGS calculations and valuation accuracy',
            'Tech - all syncs work',
          ],
          keyPoint:
            'SERP becomes source of truth. Inventory views aggregate stock_quant (no sync needed). Order queue handles reservations and COGS.',
        },
      ];

      function addDays(d, n) {
        const r = new Date(d);
        r.setDate(r.getDate() + n);
        return r;
      }
      function addWeeks(d, w) {
        return addDays(d, w * 7);
      }
      function fmt(d) {
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }
      function fmtFull(d) {
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }

      function getPhaseStart(phaseId) {
        const projectStart = new Date(PROJECT_START);
        const ends = new Map();
        for (const p of phases) {
          let start = projectStart;
          p.deps.forEach((id) => {
            const e = ends.get(id);
            if (e && e > start) start = e;
          });
          const end = addWeeks(start, p.weeks);
          ends.set(p.id, end);
          if (p.id === phaseId) return start;
        }
        return projectStart;
      }

      function render() {
        const params = new URLSearchParams(window.location.search);
        const phaseId = parseInt(params.get('id')) || 1;
        const phase = phases.find((p) => p.id === phaseId);

        if (!phase) {
          document.getElementById('title').textContent = 'Phase not found';
          return;
        }

        const start = getPhaseStart(phaseId);
        const end = addWeeks(start, phase.weeks);

        document.title = `Phase ${phase.id}: ${phase.name}`;
        document.getElementById('breadcrumb-phase').textContent = `Phase ${phase.id}`;
        document.getElementById('header').style.borderLeftColor = phase.color;
        document.getElementById('title').textContent = `Phase ${phase.id}: ${phase.name}`;
        document.getElementById('meta').textContent =
          `${fmtFull(start)} → ${fmtFull(end)} (${phase.weeks} weeks)`;
        document.getElementById('goal').textContent = phase.goal;

        let html = '';

        // Goals Section
        if (phase.goals && phase.goals.length > 0) {
          html += `<div class="section"><h2 style="border-color:${phase.color}">Goals</h2><ul>`;
          phase.goals.forEach((goal) => {
            html += `<li>${goal}</li>`;
          });
          html += `</ul></div>`;
        }

        // Workflow Section
        html += `<div class="section"><h2 style="border-color:${phase.color}">How It Works</h2>`;
        if (Array.isArray(phase.workflow)) {
          html += `<table class="workflow-table"><tr><th>Laravel (SERP)</th><th style="width:40px"></th><th>Odoo</th></tr>`;
          phase.workflow.forEach((row) => {
            // Detect section headers (rows where laravel starts with ---)
            if (row.laravel.startsWith('---')) {
              const headerText = row.laravel.replace(/^-+\s*/, '').replace(/\s*-+$/, '');
              html += `<tr><td colspan="3" style="background:${phase.color}15;color:${phase.color};font-weight:600;text-align:center;padding:12px;border-top:2px solid ${phase.color}">${headerText}</td></tr>`;
            } else {
              const rowClass = row.sync ? 'sync-row' : '';
              const arrow = row.sync ? '→' : '';
              html += `<tr class="${rowClass}"><td>${row.laravel}</td><td class="arrow">${arrow}</td><td>${row.odoo}</td></tr>`;
            }
          });
          html += `</table>`;
        } else {
          Object.entries(phase.workflow).forEach(([header, rows]) => {
            html += `<h3>${header}</h3>`;
            html += `<table class="workflow-table"><tr><th>Laravel (SERP)</th><th style="width:40px"></th><th>Odoo</th></tr>`;
            rows.forEach((row) => {
              // Detect section headers (rows where laravel starts with ---)
              if (row.laravel.startsWith('---')) {
                const headerText = row.laravel.replace(/^-+\s*/, '').replace(/\s*-+$/, '');
                html += `<tr><td colspan="3" style="background:${phase.color}15;color:${phase.color};font-weight:600;text-align:center;padding:12px;border-top:2px solid ${phase.color}">${headerText}</td></tr>`;
              } else {
                const rowClass = row.sync ? 'sync-row' : '';
                const arrow = row.sync ? '→' : '';
                html += `<tr class="${rowClass}"><td>${row.laravel}</td><td class="arrow">${arrow}</td><td>${row.odoo}</td></tr>`;
              }
            });
            html += `</table>`;
          });
        }
        if (phase.keyPoint)
          html += `<div class="highlight" style="border-color:${phase.color}"><strong>${phase.keyPoint}</strong></div>`;
        html += `</div>`;

        // Data Ownership Section
        html += `<div class="section"><h2 style="border-color:${phase.color}">Data Ownership</h2>`;
        html += `<table><tr><th>Data</th><th>Laravel</th><th>Odoo</th></tr>`;
        phase.dataOwnership.forEach((row) => {
          const laravelClass = row.laravel === 'Owner' ? 'owner-cell' : 'copy-cell';
          const odooClass = row.odoo === 'Owner' ? 'owner-cell' : 'copy-cell';
          html += `<tr><td>${row.data}</td><td class="${laravelClass}">${row.laravel}</td><td class="${odooClass}">${row.odoo}</td></tr>`;
        });
        html += `</table></div>`;

        // Database Changes Section
        html += `<div class="section"><h2 style="border-color:${phase.color}">Database Changes</h2>`;
        html += `<table><tr><th>Table</th><th>Purpose</th><th>Columns</th></tr>`;
        phase.dbChanges.forEach((row) => {
          const purpose = row.purpose || '';
          html += `<tr><td><code>${row.table}</code></td><td>${purpose}</td><td><code>${row.columns}</code></td></tr>`;
        });
        html += `</table></div>`;

        // Implementation Section
        html += `<div class="section"><h2 style="border-color:${phase.color}">Implementation Details</h2>`;
        if (Array.isArray(phase.implementation)) {
          html += `<ul>`;
          phase.implementation.forEach((item) => {
            // Detect section headers (items starting with ---)
            if (item.startsWith('---') && item.endsWith('---')) {
              const headerText = item.replace(/^-+\s*/, '').replace(/\s*-+$/, '');
              html += `</ul><h3 style="margin-top:20px;color:${phase.color}">${headerText}</h3><ul>`;
            } else {
              html += `<li>${item}</li>`;
            }
          });
          html += `</ul>`;
        } else {
          Object.entries(phase.implementation).forEach(([header, items]) => {
            html += `<h3>${header}</h3><ul>`;
            items.forEach((item) => {
              html += `<li>${item}</li>`;
            });
            html += `</ul>`;
          });
        }
        html += `</div>`;

        // Cutover Checklist Section
        if (phase.cutoverChecklist && phase.cutoverChecklist.length > 0) {
          html += `<div class="section"><h2 style="border-color:${phase.color}">Cutover Checklist</h2><ul>`;
          phase.cutoverChecklist.forEach((item) => {
            html += `<li>☐ ${item}</li>`;
          });
          html += `</ul></div>`;
        }

        // Confirmations Section
        if (phase.confirmations && phase.confirmations.length > 0) {
          html += `<div class="section"><h2 style="border-color:${phase.color}">Team Confirmations Before Launch</h2><ul>`;
          phase.confirmations.forEach((item) => {
            html += `<li>${item}</li>`;
          });
          html += `</ul></div>`;
        }

        // Questions to Decide Section
        if (phase.questionsToDecide && phase.questionsToDecide.length > 0) {
          html += `<div class="section"><h2 style="border-color:${phase.color}">Questions to Decide</h2><ul>`;
          phase.questionsToDecide.forEach((item) => {
            html += `<li>${item}</li>`;
          });
          html += `</ul></div>`;
        }

        // Timeline Section
        html += `<div class="section"><h2 style="border-color:${phase.color}">Timeline</h2>`;
        html += `<div class="gantt-container"><div class="gantt-header"><div class="gantt-label">Task</div><div class="gantt-weeks">`;
        for (let w = 1; w <= phase.weeks; w++) {
          const weekStart = addDays(start, (w - 1) * 7);
          html += `<div class="week-col">W${w}<br><span class="week-dates">${fmt(weekStart)}</span></div>`;
        }
        html += `</div></div>`;
        phase.tasks.forEach((task) => {
          const left = ((task.startWeek - 1) / phase.weeks) * 100;
          const width = (task.duration / phase.weeks) * 100;
          html += `<div class="gantt-row"><div class="task-label">${task.name}</div>`;
          html += `<div class="task-track">${Array(phase.weeks).fill('<div class="task-cell"></div>').join('')}`;
          html += `<div class="task-bar" style="left:${left}%;width:${width}%;background:${phase.color}">${task.duration}w</div></div></div>`;
        });
        html += `</div></div>`;

        document.getElementById('content').innerHTML = html;

        // Navigation
        const prevPhase = phases.find((p) => p.id === phaseId - 1);
        const nextPhase = phases.find((p) => p.id === phaseId + 1);
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        if (prevPhase) {
          prevBtn.href = `phase?id=${prevPhase.id}`;
          prevBtn.textContent = `← Phase ${prevPhase.id}: ${prevPhase.shortName}`;
          prevBtn.classList.remove('disabled');
        } else {
          prevBtn.classList.add('disabled');
          prevBtn.textContent = '← Previous';
        }

        if (nextPhase) {
          nextBtn.href = `phase?id=${nextPhase.id}`;
          nextBtn.textContent = `Phase ${nextPhase.id}: ${nextPhase.shortName} →`;
          nextBtn.classList.remove('disabled');
        } else {
          nextBtn.classList.add('disabled');
          nextBtn.textContent = 'End of Migration';
        }
      }

      render();
    </script>
  </body>
</html>
