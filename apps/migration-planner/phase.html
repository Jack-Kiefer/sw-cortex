<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phase Details</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f8f9fa;
        color: #333;
        min-height: 100vh;
        line-height: 1.6;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
      }

      .breadcrumb {
        margin-bottom: 20px;
        font-size: 0.9em;
      }
      .breadcrumb a {
        color: #198754;
        text-decoration: none;
        font-weight: 500;
      }
      .breadcrumb a:hover {
        text-decoration: underline;
      }
      .breadcrumb span {
        color: #6c757d;
        margin: 0 8px;
      }

      header {
        padding: 24px;
        background: #fff;
        border-radius: 12px;
        margin-bottom: 24px;
        border-left: 5px solid;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      header h1 {
        font-size: 1.5em;
        margin-bottom: 8px;
        color: #212529;
      }
      .phase-meta {
        color: #6c757d;
        font-size: 0.9em;
        margin-bottom: 12px;
      }
      .phase-goal {
        background: #f8f9fa;
        padding: 14px;
        border-radius: 8px;
        color: #495057;
        font-size: 0.95em;
      }

      .section {
        background: #fff;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
      }
      .section h2 {
        font-size: 1.1em;
        margin-bottom: 16px;
        padding-bottom: 10px;
        border-bottom: 2px solid;
      }
      .section h3 {
        font-size: 0.95em;
        margin: 16px 0 8px;
        color: #495057;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin: 12px 0;
        font-size: 0.9em;
      }
      th,
      td {
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
      }
      th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
      }
      .owner-cell {
        color: #198754;
        font-weight: 600;
      }
      .copy-cell {
        color: #6c757d;
      }

      .workflow-table th:first-child {
        background: #e8f5e9;
        color: #198754;
      }
      .workflow-table th:last-child {
        background: #f3e5f5;
        color: #7b1fa2;
      }
      .workflow-table .sync-row {
        background: #fff3cd;
      }
      .workflow-table .arrow {
        text-align: center;
        color: #6c757d;
      }

      ul {
        margin: 8px 0;
        padding-left: 24px;
      }
      li {
        margin: 6px 0;
      }

      .highlight {
        background: #fff3cd;
        padding: 12px 16px;
        border-left: 4px solid;
        margin: 16px 0;
        font-weight: 500;
      }

      code {
        background: #f1f3f5;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.85em;
      }

      .gantt-container {
        overflow-x: auto;
        margin-top: 16px;
      }
      .gantt-header {
        display: flex;
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 8px;
        min-width: 800px;
      }
      .gantt-label {
        width: 280px;
        min-width: 280px;
        padding: 10px;
        font-weight: 600;
        color: #495057;
        font-size: 0.85em;
      }
      .gantt-weeks {
        display: flex;
        flex: 1;
      }
      .week-col {
        flex: 1;
        text-align: center;
        padding: 8px 4px;
        font-size: 0.75em;
        font-weight: 600;
        color: #495057;
        border-left: 1px solid #e9ecef;
        background: #f8f9fa;
      }
      .week-col:first-child {
        border-left: none;
      }
      .week-dates {
        font-size: 0.7em;
        color: #6c757d;
        font-weight: 400;
      }

      .gantt-row {
        display: flex;
        align-items: center;
        min-height: 36px;
        border-bottom: 1px solid #f1f3f5;
        min-width: 800px;
      }
      .gantt-row:hover {
        background: #f8f9fa;
      }
      .task-label {
        width: 280px;
        min-width: 280px;
        padding: 6px 10px;
        font-size: 0.85em;
        color: #495057;
      }
      .task-track {
        display: flex;
        flex: 1;
        position: relative;
        height: 26px;
      }
      .task-cell {
        flex: 1;
        border-left: 1px solid #f1f3f5;
      }
      .task-cell:first-child {
        border-left: none;
      }
      .task-bar {
        position: absolute;
        height: 20px;
        top: 3px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7em;
        font-weight: 500;
        color: white;
      }

      .nav-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
      }
      .nav-btn {
        padding: 12px 20px;
        background: #fff;
        border-radius: 8px;
        text-decoration: none;
        color: #495057;
        font-weight: 500;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        transition: all 0.2s;
      }
      .nav-btn:hover {
        background: #f8f9fa;
        transform: translateY(-1px);
      }
      .nav-btn.disabled {
        opacity: 0.4;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="breadcrumb">
        <a href="index.html">Migration Plan</a><span>/</span
        ><span id="breadcrumb-phase">Phase</span>
      </div>

      <header id="header">
        <h1 id="title">Loading...</h1>
        <div class="phase-meta" id="meta"></div>
        <div class="phase-goal" id="goal"></div>
      </header>

      <div id="content"></div>

      <div class="nav-buttons">
        <a href="#" class="nav-btn" id="prev-btn">← Previous</a>
        <a href="#" class="nav-btn" id="next-btn">Next →</a>
      </div>
    </div>

    <script>
      const PROJECT_START = '2026-02-02';

      const phases = [
        {
          id: 1,
          name: 'Purchase Orders',
          shortName: 'POs',
          weeks: 8,
          deps: [],
          color: '#198754',
          goal: 'PO creation, approvals, and arrival tracking in SERP. On receipt, sync entire PO to Odoo for inventory updates.',
          goals: [
            'Move purchase order management from Odoo to SERP',
            'Enable purchasing team to create, edit, and track POs in one place',
            'Automate inventory updates in Odoo when goods are received',
            'Build foundation for future phases (bills, products, inventory)',
          ],
          tasks: [
            { name: 'Design: Define database schema and plan UX', startWeek: 1, duration: 1 },
            { name: 'Build PO list and detail views', startWeek: 2, duration: 2 },
            { name: 'Build PO creation and edit forms', startWeek: 2, duration: 2 },
            {
              name: 'Build arrival tracking UI (dock receipt → inspection)',
              startWeek: 3,
              duration: 2,
            },
            { name: 'Build Odoo XML-RPC sync for full PO on receipt', startWeek: 4, duration: 2 },
            { name: 'Purchasing team review and feedback', startWeek: 5, duration: 1 },
            { name: 'Build approval workflow UI', startWeek: 5, duration: 2 },
            {
              name: 'Build migration scripts + update dependent systems',
              startWeek: 6,
              duration: 1,
            },
            { name: 'Test sync on Odoo staging environment', startWeek: 7, duration: 1 },
            { name: 'Parallel run and final validation', startWeek: 8, duration: 1 },
          ],
          workflow: [
            { laravel: 'Create PO (draft or sent)', odoo: '—' },
            { laravel: 'Approval workflow (Ops → Finance)', odoo: '—' },
            { laravel: 'Order sent to vendor', odoo: '—' },
            { laravel: 'Dock receipt (goods arrive)', odoo: '—' },
            { laravel: 'Receiving inspection complete', odoo: '—' },
            {
              laravel: 'Inventory receipt (after inspection)',
              odoo: 'Full PO synced + stock.move created',
              sync: true,
            },
          ],
          dataOwnership: [
            {
              data: 'Purchase orders (1,846 in Odoo)',
              laravel: 'Owner',
              odoo: 'Copy (on receipt)',
            },
            {
              data: 'PO line items (14,549 lines)',
              laravel: 'Owner',
              odoo: 'Copy (on receipt)',
            },
            { data: 'Approvals & backorders', laravel: 'Owner', odoo: '—' },
            { data: 'Suppliers (156 vendors)', laravel: 'Owner', odoo: 'Mapping (partner_id)' },
            { data: 'Products, components, raw materials', laravel: '—', odoo: 'Owner' },
            { data: 'Inventory quantities', laravel: '—', odoo: 'Owner (stock_quant)' },
          ],
          dbChanges: [
            {
              table: 'Example',
              columns: 'All schema changes to be defined in Week 1 design phase',
            },
          ],
          implementation: [
            'Draft POs (save without sending to vendor)',
            'Two-stage arrival: dock receipt → inspection → inventory receipt',
            'Only inventory receipt triggers Odoo stock.move push',
            'PDF generation for PO documents',
            'Activity log (changes, notes, supplier communications)',
            'Backorder tracking for partial shipments',
            'Sync error notifications and retry queue',
          ],
          currentOdoo: [
            'purchase_order table (1,569 records)',
            'purchase_order_line table (~8,000 lines)',
            'res_partner for suppliers (156 vendors)',
            'stock_move for arrival quantities',
            'Automatic receipt creation on arrival',
          ],
          futureAdditions: [
            'Ops → Finance approval workflow',
            'Two-stage arrival (dock receipt → inspection)',
            'Partial arrival with delta sync tracking',
            'Push to Odoo status indicator',
            'Sync error notifications and retry queue',
          ],
          keyPoint:
            'One-way push to Odoo on arrival. POs live in SERP, inventory updates sync to Odoo.',
        },
        {
          id: 2,
          name: 'Bills & Blanket POs',
          shortName: 'Bills+Blanket',
          weeks: 6,
          deps: [1],
          color: '#0d6efd',
          goal: 'Bill creation from POs with QuickBooks sync. Blanket PO support for multi-release purchasing agreements.',
          goals: [
            'Enable finance team to create and approve vendor bills in SERP',
            'Link bills to POs for accurate cost tracking',
            'Support blanket POs for long-term vendor agreements',
            'Sync approved bill amounts to QuickBooks for payment',
          ],
          tasks: [
            {
              name: 'Design database updates for bills and blanket POs',
              startWeek: 1,
              duration: 1,
            },
            { name: 'Build bill creation API linked to POs', startWeek: 2, duration: 2 },
            { name: 'Build blanket PO tracking (parent-child)', startWeek: 2, duration: 2 },
            { name: 'Handle multi-PO bill consolidation', startWeek: 3, duration: 1 },
            { name: 'Migrate historical bills from Odoo', startWeek: 4, duration: 1 },
            { name: 'Build bill creation and approval UI', startWeek: 4, duration: 2 },
            { name: 'Integrate with QuickBooks', startWeek: 5, duration: 1 },
            { name: 'Train finance team', startWeek: 6, duration: 1 },
            { name: 'Go-live and cutover', startWeek: 6, duration: 1 },
          ],
          workflow: [
            { laravel: 'PO arrives (from Phase 1)', odoo: '—' },
            { laravel: 'Ops creates draft bill (qty × price)', odoo: '—' },
            { laravel: 'Compare to vendor invoice, reconcile', odoo: '—' },
            { laravel: 'Finance approves bill', odoo: '—' },
            { laravel: 'Bill finalized', odoo: 'Amount synced to QuickBooks', sync: true },
            { laravel: 'Create blanket PO (master agreement)', odoo: '—' },
            { laravel: 'Issue distribution PO from blanket', odoo: '—' },
            { laravel: 'Track remaining blanket quantity', odoo: '—' },
          ],
          dataOwnership: [
            { data: 'Vendor bills (1,569 in Odoo)', laravel: 'Owner', odoo: '—' },
            { data: 'Bill line items (~12,000)', laravel: 'Owner', odoo: '—' },
            { data: 'Bill approval workflow', laravel: 'Owner', odoo: '—' },
            { data: 'Blanket POs', laravel: 'Owner', odoo: '—' },
            { data: 'Blanket → Distribution PO links', laravel: 'Owner', odoo: '—' },
            { data: 'Payment tracking', laravel: '—', odoo: 'Owner (QuickBooks)' },
          ],
          dbChanges: [
            {
              table: 'bills',
              columns: 'EXISTS - purchase_order_id, supplier_id, status, approved_at',
            },
            { table: 'bill_items', columns: 'bill_id, purchase_item_id, qty_billed, unit_price' },
            {
              table: 'purchase_orders',
              columns: 'is_blanket, parent_blanket_po_id, remaining_qty',
            },
            {
              table: 'vendor_bill_po_links',
              columns: 'NEW - bill_id, purchase_order_id (many-to-many)',
            },
          ],
          implementation: [
            'Draft bill: qty_received × unit_price (Ops creates)',
            'Bill reconciliation with vendor invoice comparison',
            'Multi-PO bill consolidation (122 POs have multiple bills)',
            'Blanket PO with parent-child relationship',
            'Track remaining quantity on blanket POs',
            'Distribution POs trace back to blanket source',
            'Finance approval workflow before QB sync',
          ],
          currentOdoo: [
            'account_move table (1,569 vendor bills)',
            'account_move_line for bill items (~12,000)',
            'account_move_purchase_order_rel (PO-bill linking)',
            'Bill-to-PO many-to-many relationship',
            'Payment tracking in QuickBooks (not Odoo)',
          ],
          futureAdditions: [
            'Blanket PO support (multiple releases)',
            'Distribution PO tracking from blanket',
            'Remaining blanket quantity tracking',
            'Finance approval workflow',
            'QuickBooks sync for bill amounts',
            'Multi-PO bill consolidation',
          ],
          keyPoint:
            'Bills in SERP, amounts to QuickBooks. Blanket POs track purchasing agreements.',
        },
        {
          id: 3,
          name: 'Products & Manufacturing',
          shortName: 'Products+MO',
          weeks: 8,
          deps: [2],
          color: '#6f42c1',
          goal: 'Laravel is source of truth for products and MOs. Products auto-sync to Odoo on create/edit. MOs created in Laravel and synced to Odoo. Only inventory stays in Odoo (synced back to Laravel).',
          goals: [
            'Consolidate product data management in SERP',
            'Enable easy creation and tracking of manufacturing orders',
            'Maintain Odoo sync for inventory accuracy',
            'Simplify BOM management with single-level structure',
          ],
          tasks: [
            { name: 'Design database schema', startWeek: 1, duration: 1 },
            { name: 'Build product management UI', startWeek: 2, duration: 3 },
            { name: 'Build BOM and MO management UI', startWeek: 3, duration: 3 },
            { name: 'Build MO → Odoo inventory push', startWeek: 5, duration: 1 },
            { name: 'Migrate products and categories from Odoo', startWeek: 6, duration: 1 },
            { name: 'Design and migrate BOMs', startWeek: 6, duration: 1 },
            { name: 'Update all systems to reference Laravel products', startWeek: 7, duration: 1 },
            { name: 'Testing and training', startWeek: 7, duration: 1 },
            { name: 'Cutover and go-live', startWeek: 8, duration: 1 },
          ],
          workflow: [
            {
              laravel: 'Create/edit product (raw_materials, components, receiver_products)',
              odoo: 'Product auto-created/updated via sync',
              sync: true,
            },
            { laravel: 'Define BOM (normal or phantom type)', odoo: '—' },
            { laravel: 'BOM defines components for product', odoo: '—' },
            {
              laravel: 'Create manufacturing order from BOM',
              odoo: 'MO created via sync',
              sync: true,
            },
            {
              laravel: 'MO: draft → progress → done (status updates)',
              odoo: 'MO status synced',
              sync: true,
            },
            {
              laravel: 'MO complete (finished goods + components consumed)',
              odoo: 'stock.move updates inventory',
              sync: true,
            },
            {
              laravel: 'Inventory quantities updated (read-only)',
              odoo: 'Owner - synced back to Laravel',
              sync: true,
            },
          ],
          dataOwnership: [
            {
              data: 'Products (raw_materials, components, receiver_products)',
              laravel: 'Owner (source of truth)',
              odoo: 'Auto-synced copy',
            },
            { data: 'Product categories', laravel: 'Owner', odoo: 'Auto-synced copy' },
            { data: 'BOMs (2,078 total: 1,303 normal + 775 phantom)', laravel: 'Owner', odoo: '—' },
            { data: 'BOM lines (component requirements)', laravel: 'Owner', odoo: '—' },
            {
              data: 'Manufacturing orders',
              laravel: 'Owner (source of truth)',
              odoo: 'Auto-synced copy',
            },
            {
              data: 'Inventory quantities',
              laravel: 'Read-only copy (synced from Odoo)',
              odoo: 'Owner (stock_quant)',
            },
          ],
          dbChanges: [
            {
              table: 'products',
              columns: 'odoo_product_id, category_id, type (storable/consu/service)',
            },
            { table: 'product_categories', columns: 'NEW TABLE - hierarchy support' },
            { table: 'boms', columns: 'NEW TABLE - product_id, type (normal/phantom), qty' },
            { table: 'bom_lines', columns: 'NEW TABLE - bom_id, component_id, qty, operation_id' },
            { table: 'manufacturing_orders', columns: 'NEW TABLE - bom_id, qty, state, dates' },
          ],
          implementation: [
            'Product CRUD in Laravel (raw_materials, components, receiver_products tables)',
            'Auto-sync products to Odoo on create/update (XML-RPC)',
            'Single-level BOM support',
            'Phantom BOMs (775) for virtual assemblies that dissolve to components',
            'MO creation from BOM with automatic qty calculation',
            'Auto-sync MOs to Odoo on create/status updates (XML-RPC)',
            'Production tracking: draft → progress → done',
            'Inventory sync from Odoo back to Laravel (read-only in Laravel)',
          ],
          currentOdoo: [
            'Create and edit products in Odoo',
            'Create and edit BOMs in Odoo',
            'Create and track manufacturing orders in Odoo',
            'Manage product categories in Odoo',
            'Other systems pull product data from Odoo',
          ],
          futureAdditions: [
            'MO completion syncs inventory to Odoo',
            'Single source of truth for products in Laravel',
            'All systems reference Laravel for product data',
          ],
          keyPoint:
            'Laravel is source of truth for products and MOs. Auto-sync to Odoo on create/update. Only inventory owned by Odoo (synced back to Laravel).',
        },
        {
          id: 4,
          name: 'Kits & Inventory',
          shortName: 'Kits+Inventory',
          weeks: 16,
          deps: [3],
          color: '#dc3545',
          goal: 'Migrate 265 phantom BOMs to Laravel kits. Fix inventory concurrency. Build PO arrival and MO completion inventory updates. Make Laravel source of truth for all inventory.',
          goals: [
            'Migrate all phantom BOMs from Odoo to Laravel kits table',
            'Fix inventory concurrency to prevent overselling under load',
            'Build inventory increase on PO arrival and MO completion',
            'Make Odoo deprecated for daily inventory operations',
          ],
          tasks: [
            // Stage 1: Kit Migration (Weeks 1-5)
            {
              name: 'Analyze Odoo phantom BOMs, map to Laravel kit structure',
              startWeek: 1,
              duration: 1,
            },
            {
              name: 'Write phantom BOM → Laravel kits migration script',
              startWeek: 2,
              duration: 2,
            },
            {
              name: 'Validate kit-to-buyer_product links, test order expansion',
              startWeek: 4,
              duration: 1,
            },
            { name: 'Deploy kit migration, parallel run with Odoo', startWeek: 5, duration: 1 },
            // Stage 2: Fix Inventory Concurrency (Week 6)
            {
              name: 'Fix inventory deduction concurrency (atomic updates)',
              startWeek: 6,
              duration: 1,
            },
            // Stage 3: Order Inventory Deduction (Weeks 7-8)
            { name: 'Ensure atomic inventory deduction on orders', startWeek: 7, duration: 1 },
            {
              name: 'Handle edge cases: partials, cancellations, location fallbacks',
              startWeek: 8,
              duration: 1,
            },
            // Stage 4: PO Arrival Inventory (Weeks 9-11)
            { name: 'Build PO arrival → inventory increase logic', startWeek: 9, duration: 2 },
            { name: 'Test concurrent PO arrivals + order deductions', startWeek: 11, duration: 1 },
            // Stage 5: MO Completion Inventory (Weeks 12-14)
            { name: 'Build MO completion → component consumption', startWeek: 12, duration: 1 },
            {
              name: 'Build MO completion → finished goods inventory add',
              startWeek: 13,
              duration: 1,
            },
            {
              name: 'Test full MO cycle: create, complete, verify inventory',
              startWeek: 14,
              duration: 1,
            },
            // Stage 6: Cutover (Weeks 15-16)
            { name: 'Physical count and reconciliation vs Odoo', startWeek: 15, duration: 1 },
            { name: 'Go-live: deprecate Odoo for inventory', startWeek: 16, duration: 1 },
          ],
          workflow: [
            { laravel: 'Migrate 265 phantom BOMs → kits table', odoo: 'Read-only source' },
            { laravel: 'Order placed → ComponentOrder created for all kit components', odoo: '—' },
            { laravel: 'Atomic inventory deduction with concurrency protection', odoo: '—' },
            { laravel: 'PO marked arrived → inventory increased atomically', odoo: '—' },
            { laravel: 'MO completed → components consumed, finished goods added', odoo: '—' },
            { laravel: 'All inventory operations use version-checked atomic updates', odoo: '—' },
            { laravel: 'Physical count reconciliation before cutover', odoo: 'Final sync' },
          ],
          dataOwnership: [
            {
              data: 'Kit definitions (265 phantom BOMs)',
              laravel: 'Owner',
              odoo: 'Deprecated',
            },
            {
              data: 'Kit components (component_kits junction)',
              laravel: 'Owner',
              odoo: 'Deprecated',
            },
            {
              data: 'Inventory quantities',
              laravel: 'Owner (atomic updates)',
              odoo: 'Deprecated',
            },
            { data: 'PO arrival inventory adds', laravel: 'Owner', odoo: 'Deprecated' },
            { data: 'MO completion inventory changes', laravel: 'Owner', odoo: 'Deprecated' },
            { data: 'Order inventory deductions', laravel: 'Owner', odoo: 'Deprecated' },
          ],
          dbChanges: [
            { table: 'kits', columns: 'EXISTS - receives migrated phantom BOMs' },
            { table: 'component_kits', columns: 'EXISTS - kit_id, component_id, qty junction' },
            {
              table: 'component_inventory',
              columns: 'ADD version column for optimistic locking',
            },
            {
              table: 'inventory_transactions',
              columns: 'NEW - product_id, location_id, qty_change, reason, source_type, source_id',
            },
          ],
          implementation: [
            'Phantom BOM migration: INSERT SELECT from Odoo mrp_bom where type=phantom',
            '265 BOMs with avg 2-3 components each (simple structure, no nesting)',
            'Zero-qty consumables (tape, labels) migrated with qty=0',
            'Concurrency fix: UPDATE with WHERE inventory_qty >= X and version check',
            'Deadlock retry logic: 3 attempts with exponential backoff',
            'PO arrival: atomic inventory add using same locking pattern',
            'MO consumption: atomic component deduction per BOM line',
            'MO finished goods: atomic inventory add for SA products',
            'All operations logged to inventory_transactions for audit trail',
          ],
          currentOdoo: [
            'mrp_bom with type=phantom (265 active kits)',
            'mrp_bom_line for kit components (~800 records)',
            'stock_quant for current inventory (14,729 records)',
            'stock_move for movement history (48,909+ records, many stuck)',
            'No concurrency protection beyond database locks',
          ],
          futureAdditions: [
            'Atomic inventory updates with optimistic locking',
            'PO arrival → automatic inventory increase',
            'MO completion → component consumption + finished goods add',
            'Inventory transaction audit log',
            'Concurrency-safe operations under high load',
            'Physical count reconciliation before cutover',
          ],
          keyPoint:
            'Critical: Fix inventory concurrency before adding PO/MO operations. After this phase, Laravel handles all inventory atomically.',
        },
      ];

      function addDays(d, n) {
        const r = new Date(d);
        r.setDate(r.getDate() + n);
        return r;
      }
      function addWeeks(d, w) {
        return addDays(d, w * 7);
      }
      function fmt(d) {
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }
      function fmtFull(d) {
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }

      function getPhaseStart(phaseId) {
        const projectStart = new Date(PROJECT_START);
        const ends = new Map();
        for (const p of phases) {
          let start = projectStart;
          p.deps.forEach((id) => {
            const e = ends.get(id);
            if (e && e > start) start = e;
          });
          const end = addWeeks(start, p.weeks);
          ends.set(p.id, end);
          if (p.id === phaseId) return start;
        }
        return projectStart;
      }

      function render() {
        const params = new URLSearchParams(window.location.search);
        const phaseId = parseInt(params.get('id')) || 1;
        const phase = phases.find((p) => p.id === phaseId);

        if (!phase) {
          document.getElementById('title').textContent = 'Phase not found';
          return;
        }

        const start = getPhaseStart(phaseId);
        const end = addWeeks(start, phase.weeks);

        document.title = `Phase ${phase.id}: ${phase.name}`;
        document.getElementById('breadcrumb-phase').textContent = `Phase ${phase.id}`;
        document.getElementById('header').style.borderLeftColor = phase.color;
        document.getElementById('title').textContent = `Phase ${phase.id}: ${phase.name}`;
        document.getElementById('meta').textContent =
          `${fmtFull(start)} → ${fmtFull(end)} (${phase.weeks} weeks)`;
        document.getElementById('goal').textContent = phase.goal;

        let html = '';

        // Goals Section
        if (phase.goals && phase.goals.length > 0) {
          html += `<div class="section"><h2 style="border-color:${phase.color}">Goals</h2><ul>`;
          phase.goals.forEach((goal) => {
            html += `<li>${goal}</li>`;
          });
          html += `</ul></div>`;
        }

        // Workflow Section
        html += `<div class="section"><h2 style="border-color:${phase.color}">How It Works</h2>`;
        html += `<table class="workflow-table"><tr><th>Laravel (SERP)</th><th style="width:40px"></th><th>Odoo</th></tr>`;
        phase.workflow.forEach((row) => {
          const rowClass = row.sync ? 'sync-row' : '';
          const arrow = row.sync ? '→' : '';
          html += `<tr class="${rowClass}"><td>${row.laravel}</td><td class="arrow">${arrow}</td><td>${row.odoo}</td></tr>`;
        });
        html += `</table>`;
        if (phase.keyPoint)
          html += `<div class="highlight" style="border-color:${phase.color}"><strong>${phase.keyPoint}</strong></div>`;
        html += `</div>`;

        // Data Ownership Section
        html += `<div class="section"><h2 style="border-color:${phase.color}">Data Ownership</h2>`;
        html += `<table><tr><th>Data</th><th>Laravel</th><th>Odoo</th></tr>`;
        phase.dataOwnership.forEach((row) => {
          const laravelClass = row.laravel === 'Owner' ? 'owner-cell' : 'copy-cell';
          const odooClass = row.odoo === 'Owner' ? 'owner-cell' : 'copy-cell';
          html += `<tr><td>${row.data}</td><td class="${laravelClass}">${row.laravel}</td><td class="${odooClass}">${row.odoo}</td></tr>`;
        });
        html += `</table></div>`;

        // Database Changes Section
        html += `<div class="section"><h2 style="border-color:${phase.color}">Database Changes</h2>`;
        html += `<table><tr><th>Table</th><th>Columns</th></tr>`;
        phase.dbChanges.forEach((row) => {
          html += `<tr><td><code>${row.table}</code></td><td><code>${row.columns}</code></td></tr>`;
        });
        html += `</table></div>`;

        // Implementation Section
        html += `<div class="section"><h2 style="border-color:${phase.color}">Implementation Details</h2><ul>`;
        phase.implementation.forEach((item) => {
          html += `<li>${item}</li>`;
        });
        html += `</ul></div>`;

        // Existing Odoo Features Section
        html += `<div class="section"><h2 style="border-color:${phase.color}">Existing Odoo Features</h2><ul>`;
        phase.currentOdoo.forEach((item) => {
          html += `<li>${item}</li>`;
        });
        html += `</ul></div>`;

        // New Features Section
        html += `<div class="section"><h2 style="border-color:${phase.color}">New Features</h2><ul>`;
        phase.futureAdditions.forEach((item) => {
          html += `<li>${item}</li>`;
        });
        html += `</ul></div>`;

        // Timeline Section
        html += `<div class="section"><h2 style="border-color:${phase.color}">Timeline</h2>`;
        html += `<div class="gantt-container"><div class="gantt-header"><div class="gantt-label">Task</div><div class="gantt-weeks">`;
        for (let w = 1; w <= phase.weeks; w++) {
          const weekStart = addDays(start, (w - 1) * 7);
          html += `<div class="week-col">W${w}<br><span class="week-dates">${fmt(weekStart)}</span></div>`;
        }
        html += `</div></div>`;
        phase.tasks.forEach((task) => {
          const left = ((task.startWeek - 1) / phase.weeks) * 100;
          const width = (task.duration / phase.weeks) * 100;
          html += `<div class="gantt-row"><div class="task-label">${task.name}</div>`;
          html += `<div class="task-track">${Array(phase.weeks).fill('<div class="task-cell"></div>').join('')}`;
          html += `<div class="task-bar" style="left:${left}%;width:${width}%;background:${phase.color}">${task.duration}w</div></div></div>`;
        });
        html += `</div></div>`;

        document.getElementById('content').innerHTML = html;

        // Navigation
        const prevPhase = phases.find((p) => p.id === phaseId - 1);
        const nextPhase = phases.find((p) => p.id === phaseId + 1);
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        if (prevPhase) {
          prevBtn.href = `phase?id=${prevPhase.id}`;
          prevBtn.textContent = `← Phase ${prevPhase.id}: ${prevPhase.shortName}`;
          prevBtn.classList.remove('disabled');
        } else {
          prevBtn.classList.add('disabled');
          prevBtn.textContent = '← Previous';
        }

        if (nextPhase) {
          nextBtn.href = `phase?id=${nextPhase.id}`;
          nextBtn.textContent = `Phase ${nextPhase.id}: ${nextPhase.shortName} →`;
          nextBtn.classList.remove('disabled');
        } else {
          nextBtn.classList.add('disabled');
          nextBtn.textContent = 'End of Migration';
        }
      }

      render();
    </script>
  </body>
</html>
